'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.collocationSearch = exports.termSearch = undefined;

var _util = require('../util/util');

var _chapterText = require('./chapter-text');

var _word_data_map = require('../../data/word_data_map');

var _word_data_map2 = _interopRequireDefault(_word_data_map);

var _tree_data = require('../../data/tree_data');

var _tree_data2 = _interopRequireDefault(_tree_data);

var _range_node_data = require('../../data/range_node_data');

var _range_node_data2 = _interopRequireDefault(_range_node_data);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var doLog = false;
var consoleLog = function consoleLog() {
	if (doLog) {
		var _console;

		(_console = console).log.apply(_console, arguments);
	}
};

var heatUpVerseWords = function heatUpVerseWords(verse_words, hot_set, lukewarm_set) {
	return verse_words.map(function (accentUnit) {
		return accentUnit.map(function (w) {
			if (hot_set.has(w["wid"])) w["temperature"] = 2;else if (lukewarm_set.has(w["wid"])) w["temperature"] = 1;
			return w;
		});
	});
};

var _queryForWids = function _queryForWids(_ref) {
	var queryArray = _ref.queryArray,
	    search_range = _ref.search_range;

	var word_matches = [];
	var exclusions = [];
	var current_match = -1;
	var starttime = process.hrtime();
	queryArray.forEach(function (query) {
		consoleLog("BENCHMARK Q: foreach cycle ", process.hrtime(starttime));
		var invert = false;
		if ("invert" in query) {
			if (query["invert"] == "t") {
				invert = true;
			}
			delete query["invert"];
		}
		var query_matches = [];
		Object.keys(query).forEach(function (k) {
			var v = query[k];
			query_matches.push(_word_data_map2.default[k][v]);
		});
		var intersected_query_matches = _util.arrayIntersect.apply(undefined, query_matches);
		if (invert) exclusions.push.apply(exclusions, _toConsumableArray(intersected_query_matches));else word_matches.push(intersected_query_matches);
	});
	consoleLog("BENCHMARK Q: done with foreach", process.hrtime(starttime));

	var sr_matches = word_matches.map(function (m) {
		return m.map(function (n) {
			return _tree_data2.default[n][search_range];
		});
	});
	var sr_exclusions = exclusions.map(function (m) {
		return m.map(function (n) {
			return _tree_data2.default[n][search_range];
		});
	});
	var match_intersection = _util.arrayIntersect.apply(undefined, _toConsumableArray(sr_matches));
	var range_matches = (0, _util.arrayDiff)(match_intersection, sr_exclusions);
	consoleLog("BENCHMARK Q: done intersecting", process.hrtime(starttime));
	consoleLog("RESULTS:", range_matches.length);
	return { word_matches: word_matches, range_matches: range_matches };
};

var termSearch = function termSearch(params, db) {
	return new Promise(function (resolve, reject) {
		var _Array$prototype;

		var starttime = process.hrtime();
		consoleLog("BENCHMARK: starting now", process.hrtime(starttime));

		var _queryForWids2 = _queryForWids({
			queryArray: params["query"],
			search_range: params["search_range"] || "clause"
		}),
		    word_matches = _queryForWids2.word_matches,
		    range_matches = _queryForWids2.range_matches;

		var words_in_matching_ranges_set = new Set(range_matches.reduce(function (c, m) {
			return c.concat.apply(c, _toConsumableArray(_range_node_data2.default[m]["wids"]));
		}, []));
		consoleLog("BENCHMARK: getting matching word sets", process.hrtime(starttime));
		var actual_matching_words_set = new Set((0, _util.arrayIntersect)((_Array$prototype = Array.prototype).concat.apply(_Array$prototype, _toConsumableArray(word_matches)), words_in_matching_ranges_set));

		consoleLog("BENCHMARK: now formulating final data", process.hrtime(starttime));
		var ridmatches = range_matches.reduce(function (c, n) {
			return c.concat.apply(c, _toConsumableArray(_range_node_data2.default[n]["rids"]));
		}, []);
		(0, _chapterText.ridlistText)(ridmatches, new Set(["wlc", "net"]), db).then(function (ridMatchText) {
			Object.keys(ridMatchText).forEach(function (rid) {
				ridMatchText[rid]["wlc"] = heatUpVerseWords(ridMatchText[rid]["wlc"], actual_matching_words_set, words_in_matching_ranges_set);
			});
			consoleLog("BENCHMARK: results now being processed", process.hrtime(starttime));
			var match_result_data = range_matches.map(function (m) {
				var ridTextObject = {};
				_range_node_data2.default[m]["rids"].forEach(function (rid) {
					ridTextObject[rid] = ridMatchText[rid];
				});
				return {
					"node": m,
					"verses": _range_node_data2.default[m]["rids"],
					"text": ridTextObject
				};
			});

			var response = {
				"length": match_result_data.length,
				"results": match_result_data
			};
			resolve(response);
			consoleLog("BENCHMARK: done", process.hrtime(starttime));
		}).catch();
	});
};

var collocationSearch = function collocationSearch(params) {
	var grouping_key = "voc_utf8";
	return new Promise(function (resolve, reject) {
		var _queryForWids3 = _queryForWids({
			queryArray: params["query"],
			search_range: params["search_range"]
		}),
		    word_matches = _queryForWids3.word_matches;
		// params["whitelist"] == ["Verb"]


		var word_match_morph = word_matches.map(function (wid) {
			return _word_data_map2.default[wid][grouping_key];
		});
		var tally_match_data = word_match_morph.reduce(function (c, k) {
			if (!c.hasOwnProperty(k)) c[k] = 0;
			c[k]++;
			return c;
		}, {});

		var response = {
			"length": Object.keys(tally_match_data).length,
			"results": tally_match_data
		};
		resolve(response);
	});
};

exports.termSearch = termSearch;
exports.collocationSearch = collocationSearch;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvdGVybS1zZWFyY2guanMiXSwibmFtZXMiOlsiZG9Mb2ciLCJjb25zb2xlTG9nIiwibG9nIiwiaGVhdFVwVmVyc2VXb3JkcyIsInZlcnNlX3dvcmRzIiwiaG90X3NldCIsImx1a2V3YXJtX3NldCIsIm1hcCIsImFjY2VudFVuaXQiLCJoYXMiLCJ3IiwiX3F1ZXJ5Rm9yV2lkcyIsInF1ZXJ5QXJyYXkiLCJzZWFyY2hfcmFuZ2UiLCJ3b3JkX21hdGNoZXMiLCJleGNsdXNpb25zIiwiY3VycmVudF9tYXRjaCIsInN0YXJ0dGltZSIsInByb2Nlc3MiLCJocnRpbWUiLCJmb3JFYWNoIiwicXVlcnkiLCJpbnZlcnQiLCJxdWVyeV9tYXRjaGVzIiwiT2JqZWN0Iiwia2V5cyIsImsiLCJ2IiwicHVzaCIsImludGVyc2VjdGVkX3F1ZXJ5X21hdGNoZXMiLCJzcl9tYXRjaGVzIiwibSIsIm4iLCJzcl9leGNsdXNpb25zIiwibWF0Y2hfaW50ZXJzZWN0aW9uIiwicmFuZ2VfbWF0Y2hlcyIsImxlbmd0aCIsInRlcm1TZWFyY2giLCJwYXJhbXMiLCJkYiIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwid29yZHNfaW5fbWF0Y2hpbmdfcmFuZ2VzX3NldCIsIlNldCIsInJlZHVjZSIsImMiLCJjb25jYXQiLCJhY3R1YWxfbWF0Y2hpbmdfd29yZHNfc2V0IiwicHJvdG90eXBlIiwicmlkbWF0Y2hlcyIsInRoZW4iLCJyaWRNYXRjaFRleHQiLCJyaWQiLCJtYXRjaF9yZXN1bHRfZGF0YSIsInJpZFRleHRPYmplY3QiLCJyZXNwb25zZSIsImNhdGNoIiwiY29sbG9jYXRpb25TZWFyY2giLCJncm91cGluZ19rZXkiLCJ3b3JkX21hdGNoX21vcnBoIiwid2lkIiwidGFsbHlfbWF0Y2hfZGF0YSIsImhhc093blByb3BlcnR5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7OztBQUVBLElBQU1B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TXFCLGVBQWUsVUFBckI7QUFDQSxRQUFPLElBQUluQixPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQUEsdUJBQ2QvQixjQUFjO0FBQ3RDQyxlQUFZMEIsT0FBTyxPQUFQLENBRDBCO0FBRXRDekIsaUJBQWN5QixPQUFPLGNBQVA7QUFGd0IsR0FBZCxDQURjO0FBQUEsTUFDL0J4QixZQUQrQixrQkFDL0JBLFlBRCtCO0FBS3ZDOzs7QUFDQSxNQUFNOEMsbUJBQWtCOUMsYUFBYVAsR0FBYixDQUFpQjtBQUFBLFVBQU8sd0JBQVVzRCxHQUFWLEVBQWVGLFlBQWYsQ0FBUDtBQUFBLEdBQWpCLENBQXhCO0FBQ0EsTUFBTUcsbUJBQW1CRixpQkFBaUJmLE1BQWpCLENBQXdCLFVBQUNDLENBQUQsRUFBSXBCLENBQUosRUFBVTtBQUMxRCxPQUFJLENBQUNvQixFQUFFaUIsY0FBRixDQUFpQnJDLENBQWpCLENBQUwsRUFDQ29CLEVBQUVwQixDQUFGLElBQU8sQ0FBUDtBQUNEb0IsS0FBRXBCLENBQUY7QUFDQSxVQUFPb0IsQ0FBUDtBQUNBLEdBTHdCLEVBS3RCLEVBTHNCLENBQXpCOztBQU9BLE1BQU1VLFdBQVc7QUFDaEIsYUFBVWhDLE9BQU9DLElBQVAsQ0FBWXFDLGdCQUFaLEVBQThCMUIsTUFEeEI7QUFFaEIsY0FBVzBCO0FBRkssR0FBakI7QUFJQXJCLFVBQVFlLFFBQVI7QUFDQSxFQW5CTSxDQUFQO0FBb0JBLENBdEJEOztRQXdCU25CLFUsR0FBQUEsVTtRQUFZcUIsaUIsR0FBQUEsaUIiLCJmaWxlIjoidGVybS1zZWFyY2guanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhcnJheURpZmYsIGFycmF5SW50ZXJzZWN0IH0gZnJvbSAnLi4vdXRpbC91dGlsJ1xuaW1wb3J0IHsgcmlkbGlzdFRleHQgfSBmcm9tICcuL2NoYXB0ZXItdGV4dCdcblxuaW1wb3J0IHdvcmRfZGF0YSBmcm9tICcuLi8uLi9kYXRhL3dvcmRfZGF0YV9tYXAnXG5pbXBvcnQgdHJlZV9kYXRhIGZyb20gJy4uLy4uL2RhdGEvdHJlZV9kYXRhJ1xuaW1wb3J0IHJhbmdlX25vZGVfZGF0YSBmcm9tICcuLi8uLi9kYXRhL3JhbmdlX25vZGVfZGF0YSdcblxuY29uc3QgZG9Mb2cgPSBmYWxzZVxuY29uc3QgY29uc29sZUxvZyA9ICguLi5kZWJ1ZykgPT4ge1xuXHRpZiAoZG9Mb2cpIHtcblx0XHRjb25zb2xlLmxvZyguLi5kZWJ1Zylcblx0fVxufVxuXG5jb25zdCBoZWF0VXBWZXJzZVdvcmRzID0gKHZlcnNlX3dvcmRzLCBob3Rfc2V0LCBsdWtld2FybV9zZXQpID0+IHtcblx0cmV0dXJuIHZlcnNlX3dvcmRzLm1hcChhY2NlbnRVbml0ID0+IFxuXHRcdGFjY2VudFVuaXQubWFwKHcgPT4ge1xuXHRcdFx0aWYgKGhvdF9zZXQuaGFzKHdbXCJ3aWRcIl0pKVxuXHRcdFx0XHR3W1widGVtcGVyYXR1cmVcIl0gPSAyXG5cdFx0XHRlbHNlIGlmIChsdWtld2FybV9zZXQuaGFzKHdbXCJ3aWRcIl0pKVxuXHRcdFx0XHR3W1widGVtcGVyYXR1cmVcIl0gPSAxXG5cdFx0XHRyZXR1cm4gd1xuXHRcdH0pXG5cdClcbn1cblxuY29uc3QgX3F1ZXJ5Rm9yV2lkcyA9ICh7cXVlcnlBcnJheSwgc2VhcmNoX3JhbmdlfSkgPT4ge1xuXHRsZXQgd29yZF9tYXRjaGVzID0gW11cblx0bGV0IGV4Y2x1c2lvbnMgPSBbXVxuXHRsZXQgY3VycmVudF9tYXRjaCA9IC0xXG5cdGxldCBzdGFydHRpbWUgPSBwcm9jZXNzLmhydGltZSgpXG5cdHF1ZXJ5QXJyYXkuZm9yRWFjaCgocXVlcnkpID0+IHtcblx0XHRjb25zb2xlTG9nKFwiQkVOQ0hNQVJLIFE6IGZvcmVhY2ggY3ljbGUgXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0bGV0IGludmVydCA9IGZhbHNlXG5cdFx0aWYgKFwiaW52ZXJ0XCIgaW4gcXVlcnkpIHtcblx0XHRcdGlmIChxdWVyeVtcImludmVydFwiXSA9PSBcInRcIikge1xuXHRcdFx0XHRpbnZlcnQgPSB0cnVlXG5cdFx0XHR9XG5cdFx0XHRkZWxldGUgcXVlcnlbXCJpbnZlcnRcIl1cblx0XHR9XG5cdFx0bGV0IHF1ZXJ5X21hdGNoZXMgPSBbXVxuXHRcdE9iamVjdC5rZXlzKHF1ZXJ5KS5mb3JFYWNoKChrKSA9PiB7XG5cdFx0XHRjb25zdCB2ID0gcXVlcnlba11cblx0XHRcdHF1ZXJ5X21hdGNoZXMucHVzaCh3b3JkX2RhdGFba11bdl0pXG5cdFx0fSlcblx0XHRjb25zdCBpbnRlcnNlY3RlZF9xdWVyeV9tYXRjaGVzID0gYXJyYXlJbnRlcnNlY3QoLi4ucXVlcnlfbWF0Y2hlcylcblx0XHRpZiAoaW52ZXJ0KVxuXHRcdFx0ZXhjbHVzaW9ucy5wdXNoKC4uLmludGVyc2VjdGVkX3F1ZXJ5X21hdGNoZXMpXG5cdFx0ZWxzZVxuXHRcdFx0d29yZF9tYXRjaGVzLnB1c2goaW50ZXJzZWN0ZWRfcXVlcnlfbWF0Y2hlcylcblx0fSlcblx0Y29uc29sZUxvZyhcIkJFTkNITUFSSyBROiBkb25lIHdpdGggZm9yZWFjaFwiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXG5cdGNvbnN0IHNyX21hdGNoZXMgPSB3b3JkX21hdGNoZXMubWFwKG0gPT4gbS5tYXAobiA9PiB0cmVlX2RhdGFbbl1bc2VhcmNoX3JhbmdlXSkpXG5cdGNvbnN0IHNyX2V4Y2x1c2lvbnMgPSBleGNsdXNpb25zLm1hcChtID0+IG0ubWFwKG4gPT4gdHJlZV9kYXRhW25dW3NlYXJjaF9yYW5nZV0pKVxuXHRjb25zdCBtYXRjaF9pbnRlcnNlY3Rpb24gPSBhcnJheUludGVyc2VjdCguLi5zcl9tYXRjaGVzKVxuXHRjb25zdCByYW5nZV9tYXRjaGVzID0gYXJyYXlEaWZmKG1hdGNoX2ludGVyc2VjdGlvbiwgc3JfZXhjbHVzaW9ucylcblx0Y29uc29sZUxvZyhcIkJFTkNITUFSSyBROiBkb25lIGludGVyc2VjdGluZ1wiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRjb25zb2xlTG9nKFwiUkVTVUxUUzpcIiwgcmFuZ2VfbWF0Y2hlcy5sZW5ndGgpXG5cdHJldHVybiB7IHdvcmRfbWF0Y2hlcywgcmFuZ2VfbWF0Y2hlcyB9XG59XG5cbmNvbnN0IHRlcm1TZWFyY2ggPSAocGFyYW1zLCBkYik9PiB7XG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0bGV0IHN0YXJ0dGltZSA9IHByb2Nlc3MuaHJ0aW1lKClcblx0XHRjb25zb2xlTG9nKFwiQkVOQ0hNQVJLOiBzdGFydGluZyBub3dcIiwgcHJvY2Vzcy5ocnRpbWUoc3RhcnR0aW1lKSlcblx0XHRjb25zdCB7IHdvcmRfbWF0Y2hlcywgcmFuZ2VfbWF0Y2hlcyB9ID0gX3F1ZXJ5Rm9yV2lkcyh7XG5cdFx0XHRxdWVyeUFycmF5OiBwYXJhbXNbXCJxdWVyeVwiXSxcblx0XHRcdHNlYXJjaF9yYW5nZTogcGFyYW1zW1wic2VhcmNoX3JhbmdlXCJdIHx8IFwiY2xhdXNlXCJcblx0XHR9KVxuXHRcdGNvbnN0IHdvcmRzX2luX21hdGNoaW5nX3Jhbmdlc19zZXQgPSBuZXcgU2V0KHJhbmdlX21hdGNoZXMucmVkdWNlKChjLCBtKSA9PiBjLmNvbmNhdCguLi5yYW5nZV9ub2RlX2RhdGFbbV1bXCJ3aWRzXCJdKSwgW10pKVxuXHRcdGNvbnNvbGVMb2coXCJCRU5DSE1BUks6IGdldHRpbmcgbWF0Y2hpbmcgd29yZCBzZXRzXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0Y29uc3QgYWN0dWFsX21hdGNoaW5nX3dvcmRzX3NldCA9IG5ldyBTZXQoYXJyYXlJbnRlcnNlY3QoQXJyYXkucHJvdG90eXBlLmNvbmNhdCguLi53b3JkX21hdGNoZXMpLCB3b3Jkc19pbl9tYXRjaGluZ19yYW5nZXNfc2V0KSlcblxuXHRcdGNvbnNvbGVMb2coXCJCRU5DSE1BUks6IG5vdyBmb3JtdWxhdGluZyBmaW5hbCBkYXRhXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0Y29uc3QgcmlkbWF0Y2hlcyA9IHJhbmdlX21hdGNoZXMucmVkdWNlKChjLCBuKSA9PiBjLmNvbmNhdCguLi5yYW5nZV9ub2RlX2RhdGFbbl1bXCJyaWRzXCJdKSwgW10pXG5cdFx0cmlkbGlzdFRleHQocmlkbWF0Y2hlcywgbmV3IFNldChbXCJ3bGNcIiwgXCJuZXRcIl0pLCBkYikudGhlbigocmlkTWF0Y2hUZXh0KSA9PiB7XG5cdFx0XHRPYmplY3Qua2V5cyhyaWRNYXRjaFRleHQpLmZvckVhY2gocmlkID0+IHtcblx0XHRcdFx0cmlkTWF0Y2hUZXh0W3JpZF1bXCJ3bGNcIl0gPSBoZWF0VXBWZXJzZVdvcmRzKFxuXHRcdFx0XHRcdHJpZE1hdGNoVGV4dFtyaWRdW1wid2xjXCJdLFxuXHRcdFx0XHRcdGFjdHVhbF9tYXRjaGluZ193b3Jkc19zZXQsXG5cdFx0XHRcdFx0d29yZHNfaW5fbWF0Y2hpbmdfcmFuZ2VzX3NldFxuXHRcdFx0XHQpXG5cdFx0XHR9KVxuXHRcdFx0Y29uc29sZUxvZyhcIkJFTkNITUFSSzogcmVzdWx0cyBub3cgYmVpbmcgcHJvY2Vzc2VkXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0XHRjb25zdCBtYXRjaF9yZXN1bHRfZGF0YSA9IHJhbmdlX21hdGNoZXMubWFwKChtKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHJpZFRleHRPYmplY3QgPSB7fVxuXHRcdFx0XHRyYW5nZV9ub2RlX2RhdGFbbV1bXCJyaWRzXCJdLmZvckVhY2gocmlkID0+IHtcblx0XHRcdFx0XHRyaWRUZXh0T2JqZWN0W3JpZF0gPSByaWRNYXRjaFRleHRbcmlkXVxuXHRcdFx0XHR9KVxuXHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdFwibm9kZVwiOiBtLFxuXHRcdFx0XHRcdFwidmVyc2VzXCI6IHJhbmdlX25vZGVfZGF0YVttXVtcInJpZHNcIl0sXG5cdFx0XHRcdFx0XCJ0ZXh0XCI6IHJpZFRleHRPYmplY3Rcblx0XHRcdFx0fVxuXHRcdFx0fSlcblxuXHRcdFx0Y29uc3QgcmVzcG9uc2UgPSB7XG5cdFx0XHRcdFwibGVuZ3RoXCI6IG1hdGNoX3Jlc3VsdF9kYXRhLmxlbmd0aCxcblx0XHRcdFx0XCJyZXN1bHRzXCI6IG1hdGNoX3Jlc3VsdF9kYXRhXG5cdFx0XHR9XG5cdFx0XHRyZXNvbHZlKHJlc3BvbnNlKVxuXHRcdFx0Y29uc29sZUxvZyhcIkJFTkNITUFSSzogZG9uZVwiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdH0pLmNhdGNoKClcblx0fSlcbn1cblxuY29uc3QgY29sbG9jYXRpb25TZWFyY2ggPSAocGFyYW1zKT0+IHtcblx0Y29uc3QgZ3JvdXBpbmdfa2V5ID0gXCJ2b2NfdXRmOFwiXG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0Y29uc3QgeyB3b3JkX21hdGNoZXMgfSA9IF9xdWVyeUZvcldpZHMoe1xuXHRcdFx0cXVlcnlBcnJheTogcGFyYW1zW1wicXVlcnlcIl0sXG5cdFx0XHRzZWFyY2hfcmFuZ2U6IHBhcmFtc1tcInNlYXJjaF9yYW5nZVwiXVxuXHRcdH0pXG5cdFx0Ly8gcGFyYW1zW1wid2hpdGVsaXN0XCJdID09IFtcIlZlcmJcIl1cblx0XHRjb25zdCB3b3JkX21hdGNoX21vcnBoPSB3b3JkX21hdGNoZXMubWFwKHdpZCA9PiB3b3JkX2RhdGFbd2lkXVtncm91cGluZ19rZXldKVxuXHRcdGNvbnN0IHRhbGx5X21hdGNoX2RhdGEgPSB3b3JkX21hdGNoX21vcnBoLnJlZHVjZSgoYywgaykgPT4ge1xuXHRcdFx0aWYgKCFjLmhhc093blByb3BlcnR5KGspKVxuXHRcdFx0XHRjW2tdID0gMFxuXHRcdFx0Y1trXSsrXG5cdFx0XHRyZXR1cm4gY1xuXHRcdH0sIHt9KVxuXG5cdFx0Y29uc3QgcmVzcG9uc2UgPSB7XG5cdFx0XHRcImxlbmd0aFwiOiBPYmplY3Qua2V5cyh0YWxseV9tYXRjaF9kYXRhKS5sZW5ndGgsXG5cdFx0XHRcInJlc3VsdHNcIjogdGFsbHlfbWF0Y2hfZGF0YVxuXHRcdH1cblx0XHRyZXNvbHZlKHJlc3BvbnNlKVxuXHR9KVxufVxuXG5leHBvcnQgeyB0ZXJtU2VhcmNoLCBjb2xsb2NhdGlvblNlYXJjaCB9Il19