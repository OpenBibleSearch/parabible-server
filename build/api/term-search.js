'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports._wordsThatMatchQuery = exports.collocationSearch = exports.termSearch = undefined;

var _util = require('../util/util');

var _chapterText = require('./chapter-text');

var _word_data_map = require('../../data/word_data_map');

var _word_data_map2 = _interopRequireDefault(_word_data_map);

var _tree_data = require('../../data/tree_data');

var _tree_data2 = _interopRequireDefault(_tree_data);

var _range_node_data = require('../../data/range_node_data');

var _range_node_data2 = _interopRequireDefault(_range_node_data);

var _book_names = require('../../data/book_names');

var _book_names2 = _interopRequireDefault(_book_names);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var doLog = false;
var consoleLog = function consoleLog() {
	if (doLog) {
		var _console;

		(_console = console).log.apply(_console, arguments);
	}
};

var heatUpVerseWords = function heatUpVerseWords(verse_words, hot_set, lukewarm_set) {
	return verse_words.map(function (accentUnit) {
		return accentUnit.map(function (w) {
			if (hot_set.has(w["wid"])) w["temperature"] = 2;else if (lukewarm_set.has(w["wid"])) w["temperature"] = 1;
			return w;
		});
	});
};

var _doFilter = function _doFilter(filter, wordNodes) {
	var chapterFilter = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;

	if (filter.length > 0) {
		var chapterOffset = chapterFilter * 1000;
		var ridFilter = filter.map(function (f) {
			return _book_names2.default[f] * 10000000 + chapterOffset;
		});

		var extent = chapterFilter === 0 ? 10000000 : 1000;
		return wordNodes.filter(function (w) {
			var rid = _tree_data2.default[w].verse;
			return ridFilter.reduce(function (a, v) {
				return a || v <= rid && rid < v + extent;
			}, false);
		});
	} else {
		return wordNodes;
	}
};
var _wordsThatMatchQuery = function _wordsThatMatchQuery(query, filter) {
	var chapterFilter = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;

	var query_matches = [];
	Object.keys(query).forEach(function (k) {
		var v = query[k];
		query_matches.push(_doFilter(filter, _word_data_map2.default[k][v], chapterFilter));
	});
	return _util.arrayIntersect.apply(undefined, query_matches);
};
var _queryForWids = function _queryForWids(_ref) {
	var queryArray = _ref.queryArray,
	    search_range = _ref.search_range,
	    search_filter = _ref.search_filter;

	var word_matches = [];
	var exclusions = [];
	var current_match = -1;
	// let starttime = process.hrtime()
	queryArray.forEach(function (query) {
		// consoleLog("BENCHMARK Q: foreach cycle ", process.hrtime(starttime))
		var query_matches = _wordsThatMatchQuery(query.data, search_filter);

		if (query.invert) exclusions.push.apply(exclusions, _toConsumableArray(query_matches));else word_matches.push(query_matches);
	});
	// consoleLog("BENCHMARK Q: done with foreach", process.hrtime(starttime))

	var sr_matches = word_matches.map(function (m) {
		return m.map(function (n) {
			return _tree_data2.default[n][search_range];
		});
	});
	var sr_exclusions = exclusions.map(function (m) {
		return _tree_data2.default[m][search_range];
	});
	var match_intersection = _util.arrayIntersect.apply(undefined, _toConsumableArray(sr_matches));
	var range_matches = (0, _util.arrayDiff)(match_intersection, sr_exclusions);
	// consoleLog("BENCHMARK Q: done intersecting", process.hrtime(starttime))
	// consoleLog("RESULTS:", range_matches.length)
	return { word_matches: word_matches, range_matches: range_matches };
};

var termSearch = function termSearch(params, db) {
	return new Promise(function (resolve, reject) {
		var _Array$prototype;

		// let starttime = process.hrtime()
		// consoleLog("BENCHMARK: starting now", process.hrtime(starttime))
		var _queryForWids2 = _queryForWids({
			queryArray: params["query"],
			search_range: params["search_range"] || "clause",
			search_filter: params["search_filter"] || []
		}),
		    word_matches = _queryForWids2.word_matches,
		    range_matches = _queryForWids2.range_matches;

		var words_in_matching_ranges_set = new Set(range_matches.reduce(function (c, m) {
			return c.concat.apply(c, _toConsumableArray(_range_node_data2.default[m]["wids"]));
		}, []));
		// consoleLog("BENCHMARK: getting matching word sets", process.hrtime(starttime))
		var actual_matching_words_set = new Set((0, _util.arrayIntersect)((_Array$prototype = Array.prototype).concat.apply(_Array$prototype, _toConsumableArray(word_matches)), words_in_matching_ranges_set));

		// consoleLog("BENCHMARK: now formulating final data", process.hrtime(starttime))
		var ridmatches = range_matches.reduce(function (c, n) {
			return c.concat.apply(c, _toConsumableArray(_range_node_data2.default[n]["rids"]));
		}, []);
		(0, _chapterText.ridlistText)(ridmatches, new Set(["wlc", "net"]), db).then(function (ridMatchText) {
			Object.keys(ridMatchText).forEach(function (rid) {
				ridMatchText[rid]["wlc"] = heatUpVerseWords(ridMatchText[rid]["wlc"], actual_matching_words_set, words_in_matching_ranges_set);
			});
			// consoleLog("BENCHMARK: results now being processed", process.hrtime(starttime))
			var match_result_data = range_matches.map(function (m) {
				var ridTextObject = {};
				_range_node_data2.default[m]["rids"].forEach(function (rid) {
					ridTextObject[rid] = ridMatchText[rid];
				});
				return {
					"node": m,
					"verses": _range_node_data2.default[m]["rids"],
					"text": ridTextObject
				};
			});

			var response = {
				"length": match_result_data.length,
				"results": match_result_data
			};
			resolve(response);
			// consoleLog("BENCHMARK: done", process.hrtime(starttime))
		}).catch();
	});
};

var collocationSearch = function collocationSearch(params) {
	var grouping_key = "voc_utf8";
	return new Promise(function (resolve, reject) {
		var _queryForWids3 = _queryForWids({
			queryArray: params["query"],
			search_range: params["search_range"]
		}),
		    word_matches = _queryForWids3.word_matches;
		// params["whitelist"] == ["Verb"]


		var word_match_morph = word_matches.map(function (wid) {
			return _word_data_map2.default[wid][grouping_key];
		});
		var tally_match_data = word_match_morph.reduce(function (c, k) {
			if (!c.hasOwnProperty(k)) c[k] = 0;
			c[k]++;
			return c;
		}, {});

		var response = {
			"length": Object.keys(tally_match_data).length,
			"results": tally_match_data
		};
		resolve(response);
	});
};

exports.termSearch = termSearch;
exports.collocationSearch = collocationSearch;
exports._wordsThatMatchQuery = _wordsThatMatchQuery;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvdGVybS1zZWFyY2guanMiXSwibmFtZXMiOlsiZG9Mb2ciLCJjb25zb2xlTG9nIiwibG9nIiwiaGVhdFVwVmVyc2VXb3JkcyIsInZlcnNlX3dvcmRzIiwiaG90X3NldCIsImx1a2V3YXJtX3NldCIsIm1hcCIsImFjY2VudFVuaXQiLCJoYXMiLCJ3IiwiX2RvRmlsdGVyIiwiZmlsdGVyIiwid29yZE5vZGVzIiwiY2hhcHRlckZpbHRlciIsImxlbmd0aCIsImNoYXB0ZXJPZmZzZXQiLCJyaWRGaWx0ZXIiLCJmIiwiZXh0ZW50IiwicmlkIiwidmVyc2UiLCJyZWR1Y2UiLCJhIiwidiIsIl93b3Jkc1RoYXRNYXRjaFF1ZXJ5IiwicXVlcnkiLCJxdWVyeV9tYXRjaGVzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrIiwicHVzaCIsIl9xdWVyeUZvcldpZHMiLCJxdWVyeUFycmF5Iiwic2VhcmNoX3JhbmdlIiwic2VhcmNoX2ZpbHRlciIsIndvcmRfbWF0Y2hlcyIsImV4Y2x1c2lvbnMiLCJjdXJyZW50X21hdGNoIiwiZGF0YSIsImludmVydCIsInNyX21hdGNoZXMiLCJtIiwibiIsInNyX2V4Y2x1c2lvbnMiLCJtYXRjaF9pbnRlcnNlY3Rpb24iLCJyYW5nZV9tYXRjaGVzIiwidGVybVNlYXJjaCIsInBhcmFtcyIsImRiIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJ3b3Jkc19pbl9tYXRjaGluZ19yYW5nZXNfc2V0IiwiU2V0IiwiYyIsImNvbmNhdCIsImFjdHVhbF9tYXRjaGluZ193b3Jkc19zZXQiLCJwcm90b3R5cGUiLCJyaWRtYXRjaGVzIiwidGhlbiIsInJpZE1hdGNoVGV4dCIsIm1hdGNoX3Jlc3VsdF9kYXRhIiwicmlkVGV4dE9iamVjdCIsInJlc3BvbnNlIiwiY2F0Y2giLCJjb2xsb2NhdGlvblNlYXJjaCIsImdyb3VwaW5nX2tleSIsIndvcmRfbWF0Y2hfbW9ycGgiLCJ3aWQiLCJ0YWxseV9tYXRjaF9kYXRh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d0JTakIsVSxHQUFBQSxVO1FBQVltQixpQixHQUFBQSxpQjtRQUFtQjFDLG9CLEdBQUFBLG9CIiwiZmlsZSI6InRlcm0tc2VhcmNoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXJyYXlEaWZmLCBhcnJheUludGVyc2VjdCB9IGZyb20gJy4uL3V0aWwvdXRpbCdcbmltcG9ydCB7IHJpZGxpc3RUZXh0IH0gZnJvbSAnLi9jaGFwdGVyLXRleHQnXG5cbmltcG9ydCB3b3JkX2RhdGEgZnJvbSAnLi4vLi4vZGF0YS93b3JkX2RhdGFfbWFwJ1xuaW1wb3J0IHRyZWVfZGF0YSBmcm9tICcuLi8uLi9kYXRhL3RyZWVfZGF0YSdcbmltcG9ydCByYW5nZV9ub2RlX2RhdGEgZnJvbSAnLi4vLi4vZGF0YS9yYW5nZV9ub2RlX2RhdGEnXG5pbXBvcnQgYm9va19uYW1lcyBmcm9tICcuLi8uLi9kYXRhL2Jvb2tfbmFtZXMnXG5cbmNvbnN0IGRvTG9nID0gZmFsc2VcbmNvbnN0IGNvbnNvbGVMb2cgPSAoLi4uZGVidWcpID0+IHtcblx0aWYgKGRvTG9nKSB7XG5cdFx0Y29uc29sZS5sb2coLi4uZGVidWcpXG5cdH1cbn1cblxuY29uc3QgaGVhdFVwVmVyc2VXb3JkcyA9ICh2ZXJzZV93b3JkcywgaG90X3NldCwgbHVrZXdhcm1fc2V0KSA9PiB7XG5cdHJldHVybiB2ZXJzZV93b3Jkcy5tYXAoYWNjZW50VW5pdCA9PiBcblx0XHRhY2NlbnRVbml0Lm1hcCh3ID0+IHtcblx0XHRcdGlmIChob3Rfc2V0Lmhhcyh3W1wid2lkXCJdKSlcblx0XHRcdFx0d1tcInRlbXBlcmF0dXJlXCJdID0gMlxuXHRcdFx0ZWxzZSBpZiAobHVrZXdhcm1fc2V0Lmhhcyh3W1wid2lkXCJdKSlcblx0XHRcdFx0d1tcInRlbXBlcmF0dXJlXCJdID0gMVxuXHRcdFx0cmV0dXJuIHdcblx0XHR9KVxuXHQpXG59XG5cbmNvbnN0IF9kb0ZpbHRlciA9IChmaWx0ZXIsIHdvcmROb2RlcywgY2hhcHRlckZpbHRlcj0wKSA9PiB7XG5cdGlmIChmaWx0ZXIubGVuZ3RoID4gMCkge1xuXHRcdGNvbnN0IGNoYXB0ZXJPZmZzZXQgPSBjaGFwdGVyRmlsdGVyICogMTAwMFxuXHRcdGNvbnN0IHJpZEZpbHRlciA9IGZpbHRlci5tYXAoZiA9PiBib29rX25hbWVzW2ZdICogMTAwMDAwMDAgKyBjaGFwdGVyT2Zmc2V0KVxuXG5cdFx0Y29uc3QgZXh0ZW50ID0gY2hhcHRlckZpbHRlciA9PT0gMCA/IDEwMDAwMDAwIDogMTAwMFxuXHRcdHJldHVybiB3b3JkTm9kZXMuZmlsdGVyKHcgPT4ge1xuXHRcdFx0Y29uc3QgcmlkID0gdHJlZV9kYXRhW3ddLnZlcnNlXG5cdFx0XHRyZXR1cm4gcmlkRmlsdGVyLnJlZHVjZSgoYSwgdikgPT4gYSB8fCB2IDw9IHJpZCAmJiByaWQgPCB2ICsgZXh0ZW50LCBmYWxzZSlcblx0XHR9KVxuXHR9XG5cdGVsc2Uge1xuXHRcdHJldHVybiB3b3JkTm9kZXNcblx0fVxufVxuY29uc3QgX3dvcmRzVGhhdE1hdGNoUXVlcnkgPSAocXVlcnksIGZpbHRlciwgY2hhcHRlckZpbHRlcj0wKSA9PiB7XG5cdGxldCBxdWVyeV9tYXRjaGVzID0gW11cblx0T2JqZWN0LmtleXMocXVlcnkpLmZvckVhY2goKGspID0+IHtcblx0XHRjb25zdCB2ID0gcXVlcnlba11cblx0XHRxdWVyeV9tYXRjaGVzLnB1c2goX2RvRmlsdGVyKGZpbHRlciwgd29yZF9kYXRhW2tdW3ZdLCBjaGFwdGVyRmlsdGVyKSlcblx0fSlcblx0cmV0dXJuIGFycmF5SW50ZXJzZWN0KC4uLnF1ZXJ5X21hdGNoZXMpXG59XG5jb25zdCBfcXVlcnlGb3JXaWRzID0gKHtxdWVyeUFycmF5LCBzZWFyY2hfcmFuZ2UsIHNlYXJjaF9maWx0ZXJ9KSA9PiB7XG5cdGxldCB3b3JkX21hdGNoZXMgPSBbXVxuXHRsZXQgZXhjbHVzaW9ucyA9IFtdXG5cdGxldCBjdXJyZW50X21hdGNoID0gLTFcblx0Ly8gbGV0IHN0YXJ0dGltZSA9IHByb2Nlc3MuaHJ0aW1lKClcblx0cXVlcnlBcnJheS5mb3JFYWNoKChxdWVyeSkgPT4ge1xuXHRcdC8vIGNvbnNvbGVMb2coXCJCRU5DSE1BUksgUTogZm9yZWFjaCBjeWNsZSBcIiwgcHJvY2Vzcy5ocnRpbWUoc3RhcnR0aW1lKSlcblx0XHRjb25zdCBxdWVyeV9tYXRjaGVzID0gX3dvcmRzVGhhdE1hdGNoUXVlcnkocXVlcnkuZGF0YSwgc2VhcmNoX2ZpbHRlcilcblxuXHRcdGlmIChxdWVyeS5pbnZlcnQpXG5cdFx0XHRleGNsdXNpb25zLnB1c2goLi4ucXVlcnlfbWF0Y2hlcylcblx0XHRlbHNlXG5cdFx0XHR3b3JkX21hdGNoZXMucHVzaChxdWVyeV9tYXRjaGVzKVxuXHR9KVxuXHQvLyBjb25zb2xlTG9nKFwiQkVOQ0hNQVJLIFE6IGRvbmUgd2l0aCBmb3JlYWNoXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cblx0Y29uc3Qgc3JfbWF0Y2hlcyA9IHdvcmRfbWF0Y2hlcy5tYXAobSA9PiBtLm1hcChuID0+IHRyZWVfZGF0YVtuXVtzZWFyY2hfcmFuZ2VdKSlcblx0Y29uc3Qgc3JfZXhjbHVzaW9ucyA9IGV4Y2x1c2lvbnMubWFwKG0gPT4gdHJlZV9kYXRhW21dW3NlYXJjaF9yYW5nZV0pXG5cdGNvbnN0IG1hdGNoX2ludGVyc2VjdGlvbiA9IGFycmF5SW50ZXJzZWN0KC4uLnNyX21hdGNoZXMpXG5cdGNvbnN0IHJhbmdlX21hdGNoZXMgPSBhcnJheURpZmYobWF0Y2hfaW50ZXJzZWN0aW9uLCBzcl9leGNsdXNpb25zKVxuXHQvLyBjb25zb2xlTG9nKFwiQkVOQ0hNQVJLIFE6IGRvbmUgaW50ZXJzZWN0aW5nXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdC8vIGNvbnNvbGVMb2coXCJSRVNVTFRTOlwiLCByYW5nZV9tYXRjaGVzLmxlbmd0aClcblx0cmV0dXJuIHsgd29yZF9tYXRjaGVzLCByYW5nZV9tYXRjaGVzIH1cbn1cblxuY29uc3QgdGVybVNlYXJjaCA9IChwYXJhbXMsIGRiKT0+IHtcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHQvLyBsZXQgc3RhcnR0aW1lID0gcHJvY2Vzcy5ocnRpbWUoKVxuXHRcdC8vIGNvbnNvbGVMb2coXCJCRU5DSE1BUks6IHN0YXJ0aW5nIG5vd1wiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdGNvbnN0IHsgd29yZF9tYXRjaGVzLCByYW5nZV9tYXRjaGVzIH0gPSBfcXVlcnlGb3JXaWRzKHtcblx0XHRcdHF1ZXJ5QXJyYXk6IHBhcmFtc1tcInF1ZXJ5XCJdLFxuXHRcdFx0c2VhcmNoX3JhbmdlOiBwYXJhbXNbXCJzZWFyY2hfcmFuZ2VcIl0gfHwgXCJjbGF1c2VcIixcblx0XHRcdHNlYXJjaF9maWx0ZXI6IHBhcmFtc1tcInNlYXJjaF9maWx0ZXJcIl0gfHwgW11cblx0XHR9KVxuXHRcdGNvbnN0IHdvcmRzX2luX21hdGNoaW5nX3Jhbmdlc19zZXQgPSBuZXcgU2V0KHJhbmdlX21hdGNoZXMucmVkdWNlKChjLCBtKSA9PiBjLmNvbmNhdCguLi5yYW5nZV9ub2RlX2RhdGFbbV1bXCJ3aWRzXCJdKSwgW10pKVxuXHRcdC8vIGNvbnNvbGVMb2coXCJCRU5DSE1BUks6IGdldHRpbmcgbWF0Y2hpbmcgd29yZCBzZXRzXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0Y29uc3QgYWN0dWFsX21hdGNoaW5nX3dvcmRzX3NldCA9IG5ldyBTZXQoYXJyYXlJbnRlcnNlY3QoQXJyYXkucHJvdG90eXBlLmNvbmNhdCguLi53b3JkX21hdGNoZXMpLCB3b3Jkc19pbl9tYXRjaGluZ19yYW5nZXNfc2V0KSlcblxuXHRcdC8vIGNvbnNvbGVMb2coXCJCRU5DSE1BUks6IG5vdyBmb3JtdWxhdGluZyBmaW5hbCBkYXRhXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0Y29uc3QgcmlkbWF0Y2hlcyA9IHJhbmdlX21hdGNoZXMucmVkdWNlKChjLCBuKSA9PiBjLmNvbmNhdCguLi5yYW5nZV9ub2RlX2RhdGFbbl1bXCJyaWRzXCJdKSwgW10pXG5cdFx0cmlkbGlzdFRleHQocmlkbWF0Y2hlcywgbmV3IFNldChbXCJ3bGNcIiwgXCJuZXRcIl0pLCBkYikudGhlbigocmlkTWF0Y2hUZXh0KSA9PiB7XG5cdFx0XHRPYmplY3Qua2V5cyhyaWRNYXRjaFRleHQpLmZvckVhY2gocmlkID0+IHtcblx0XHRcdFx0cmlkTWF0Y2hUZXh0W3JpZF1bXCJ3bGNcIl0gPSBoZWF0VXBWZXJzZVdvcmRzKFxuXHRcdFx0XHRcdHJpZE1hdGNoVGV4dFtyaWRdW1wid2xjXCJdLFxuXHRcdFx0XHRcdGFjdHVhbF9tYXRjaGluZ193b3Jkc19zZXQsXG5cdFx0XHRcdFx0d29yZHNfaW5fbWF0Y2hpbmdfcmFuZ2VzX3NldFxuXHRcdFx0XHQpXG5cdFx0XHR9KVxuXHRcdFx0Ly8gY29uc29sZUxvZyhcIkJFTkNITUFSSzogcmVzdWx0cyBub3cgYmVpbmcgcHJvY2Vzc2VkXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0XHRjb25zdCBtYXRjaF9yZXN1bHRfZGF0YSA9IHJhbmdlX21hdGNoZXMubWFwKChtKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHJpZFRleHRPYmplY3QgPSB7fVxuXHRcdFx0XHRyYW5nZV9ub2RlX2RhdGFbbV1bXCJyaWRzXCJdLmZvckVhY2gocmlkID0+IHtcblx0XHRcdFx0XHRyaWRUZXh0T2JqZWN0W3JpZF0gPSByaWRNYXRjaFRleHRbcmlkXVxuXHRcdFx0XHR9KVxuXHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdFwibm9kZVwiOiBtLFxuXHRcdFx0XHRcdFwidmVyc2VzXCI6IHJhbmdlX25vZGVfZGF0YVttXVtcInJpZHNcIl0sXG5cdFx0XHRcdFx0XCJ0ZXh0XCI6IHJpZFRleHRPYmplY3Rcblx0XHRcdFx0fVxuXHRcdFx0fSlcblxuXHRcdFx0Y29uc3QgcmVzcG9uc2UgPSB7XG5cdFx0XHRcdFwibGVuZ3RoXCI6IG1hdGNoX3Jlc3VsdF9kYXRhLmxlbmd0aCxcblx0XHRcdFx0XCJyZXN1bHRzXCI6IG1hdGNoX3Jlc3VsdF9kYXRhXG5cdFx0XHR9XG5cdFx0XHRyZXNvbHZlKHJlc3BvbnNlKVxuXHRcdFx0Ly8gY29uc29sZUxvZyhcIkJFTkNITUFSSzogZG9uZVwiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdH0pLmNhdGNoKClcblx0fSlcbn1cblxuY29uc3QgY29sbG9jYXRpb25TZWFyY2ggPSAocGFyYW1zKT0+IHtcblx0Y29uc3QgZ3JvdXBpbmdfa2V5ID0gXCJ2b2NfdXRmOFwiXG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0Y29uc3QgeyB3b3JkX21hdGNoZXMgfSA9IF9xdWVyeUZvcldpZHMoe1xuXHRcdFx0cXVlcnlBcnJheTogcGFyYW1zW1wicXVlcnlcIl0sXG5cdFx0XHRzZWFyY2hfcmFuZ2U6IHBhcmFtc1tcInNlYXJjaF9yYW5nZVwiXVxuXHRcdH0pXG5cdFx0Ly8gcGFyYW1zW1wid2hpdGVsaXN0XCJdID09IFtcIlZlcmJcIl1cblx0XHRjb25zdCB3b3JkX21hdGNoX21vcnBoPSB3b3JkX21hdGNoZXMubWFwKHdpZCA9PiB3b3JkX2RhdGFbd2lkXVtncm91cGluZ19rZXldKVxuXHRcdGNvbnN0IHRhbGx5X21hdGNoX2RhdGEgPSB3b3JkX21hdGNoX21vcnBoLnJlZHVjZSgoYywgaykgPT4ge1xuXHRcdFx0aWYgKCFjLmhhc093blByb3BlcnR5KGspKVxuXHRcdFx0XHRjW2tdID0gMFxuXHRcdFx0Y1trXSsrXG5cdFx0XHRyZXR1cm4gY1xuXHRcdH0sIHt9KVxuXG5cdFx0Y29uc3QgcmVzcG9uc2UgPSB7XG5cdFx0XHRcImxlbmd0aFwiOiBPYmplY3Qua2V5cyh0YWxseV9tYXRjaF9kYXRhKS5sZW5ndGgsXG5cdFx0XHRcInJlc3VsdHNcIjogdGFsbHlfbWF0Y2hfZGF0YVxuXHRcdH1cblx0XHRyZXNvbHZlKHJlc3BvbnNlKVxuXHR9KVxufVxuXG5leHBvcnQgeyB0ZXJtU2VhcmNoLCBjb2xsb2NhdGlvblNlYXJjaCwgX3dvcmRzVGhhdE1hdGNoUXVlcnkgfSJdfQ==