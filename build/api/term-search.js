'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.collocationSearch = exports.termSearch = undefined;

var _util = require('../util/util');

var _chapterText = require('./chapter-text');

var _word_data_map = require('../../data/word_data_map');

var _word_data_map2 = _interopRequireDefault(_word_data_map);

var _tree_data = require('../../data/tree_data');

var _tree_data2 = _interopRequireDefault(_tree_data);

var _range_node_data = require('../../data/range_node_data');

var _range_node_data2 = _interopRequireDefault(_range_node_data);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var doLog = false;
var consoleLog = function consoleLog() {
	if (doLog) {
		var _console;

		(_console = console).log.apply(_console, arguments);
	}
};

var heatUpVerseWords = function heatUpVerseWords(verse_words, hot_set, lukewarm_set) {
	return verse_words.map(function (accentUnit) {
		return accentUnit.map(function (w) {
			if (hot_set.has(w["wid"])) w["temperature"] = 2;else if (lukewarm_set.has(w["wid"])) w["temperature"] = 1;
			return w;
		});
	});
};

var _queryForWids = function _queryForWids(_ref) {
	var queryArray = _ref.queryArray,
	    search_range = _ref.search_range;

	var word_matches = [];
	var exclusions = [];
	var current_match = -1;
	var starttime = process.hrtime();
	queryArray.forEach(function (query) {
		consoleLog("BENCHMARK Q: foreach cycle ", process.hrtime(starttime));
		var invert = false;
		if ("invert" in query) {
			if (query["invert"] == "t") {
				invert = true;
			}
			delete query["invert"];
		}
		var query_matches = [];
		Object.keys(query).forEach(function (k) {
			var v = query[k];
			query_matches.push(_word_data_map2.default[k][v]);
		});
		var intersected_query_matches = _util.arrayIntersect.apply(undefined, query_matches);
		if (invert) exclusions.push.apply(exclusions, _toConsumableArray(intersected_query_matches));else word_matches.push(intersected_query_matches);
	});
	consoleLog("BENCHMARK Q: done with foreach", process.hrtime(starttime));

	var sr_matches = word_matches.map(function (m) {
		return m.map(function (n) {
			return _tree_data2.default[n][search_range];
		});
	});
	var sr_exclusions = exclusions.map(function (m) {
		return m.map(function (n) {
			return _tree_data2.default[n][search_range];
		});
	});
	var match_intersection = _util.arrayIntersect.apply(undefined, _toConsumableArray(sr_matches));
	var range_matches = (0, _util.arrayDiff)(match_intersection, sr_exclusions);
	consoleLog("BENCHMARK Q: done intersecting", process.hrtime(starttime));
	consoleLog("RESULTS:", range_matches.length);
	return { word_matches: word_matches, range_matches: range_matches };
};

var termSearch = function termSearch(params, db) {
	return new Promise(function (resolve, reject) {
		var _Array$prototype;

		var starttime = process.hrtime();
		consoleLog("BENCHMARK: starting now", process.hrtime(starttime));

		var _queryForWids2 = _queryForWids({
			queryArray: params["query"],
			search_range: params["search_range"] || "clause"
		}),
		    word_matches = _queryForWids2.word_matches,
		    range_matches = _queryForWids2.range_matches;

		var words_in_matching_ranges_set = new Set(range_matches.reduce(function (c, m) {
			return c.concat.apply(c, _toConsumableArray(_range_node_data2.default[m]["wids"]));
		}, []));
		consoleLog("BENCHMARK: getting matching word sets", process.hrtime(starttime));
		var actual_matching_words_set = new Set((0, _util.arrayIntersect)((_Array$prototype = Array.prototype).concat.apply(_Array$prototype, _toConsumableArray(word_matches)), words_in_matching_ranges_set));

		consoleLog("BENCHMARK: now formulating final data", process.hrtime(starttime));
		var ridmatches = range_matches.reduce(function (c, n) {
			return c.concat.apply(c, _toConsumableArray(_range_node_data2.default[n]["rids"]));
		}, []);
		(0, _chapterText.ridlistText)(ridmatches, new Set(["wlc", "net"]), db).then(function (ridMatchText) {
			Object.keys(ridMatchText).forEach(function (rid) {
				ridMatchText[rid]["wlc"] = heatUpVerseWords(ridMatchText[rid]["wlc"], actual_matching_words_set, words_in_matching_ranges_set);
			});
			consoleLog("BENCHMARK: results now being processed", process.hrtime(starttime));
			var match_result_data = range_matches.map(function (m) {
				return {
					"node": m,
					"verses": _range_node_data2.default[m]["rids"],
					"text": _range_node_data2.default[m]["rids"].map(function (rid) {
						return _defineProperty({}, rid, ridMatchText[rid]);
					})
				};
			});

			var response = {
				"length": match_result_data.length,
				"results": match_result_data
			};
			resolve(response);
			consoleLog("BENCHMARK: done", process.hrtime(starttime));
		}).catch();
	});
};

var collocationSearch = function collocationSearch(params) {
	var grouping_key = "voc_utf8";
	return new Promise(function (resolve, reject) {
		var _queryForWids3 = _queryForWids({
			queryArray: params["query"],
			search_range: params["search_range"]
		}),
		    word_matches = _queryForWids3.word_matches;
		// params["whitelist"] == ["Verb"]


		var word_match_morph = word_matches.map(function (wid) {
			return _word_data_map2.default[wid][grouping_key];
		});
		var tally_match_data = word_match_morph.reduce(function (c, k) {
			if (!c.hasOwnProperty(k)) c[k] = 0;
			c[k]++;
			return c;
		}, {});

		var response = {
			"length": Object.keys(tally_match_data).length,
			"results": tally_match_data
		};
		resolve(response);
	});
};

exports.termSearch = termSearch;
exports.collocationSearch = collocationSearch;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvdGVybS1zZWFyY2guanMiXSwibmFtZXMiOlsiZG9Mb2ciLCJjb25zb2xlTG9nIiwibG9nIiwiaGVhdFVwVmVyc2VXb3JkcyIsInZlcnNlX3dvcmRzIiwiaG90X3NldCIsImx1a2V3YXJtX3NldCIsIm1hcCIsImFjY2VudFVuaXQiLCJoYXMiLCJ3IiwiX3F1ZXJ5Rm9yV2lkcyIsInF1ZXJ5QXJyYXkiLCJzZWFyY2hfcmFuZ2UiLCJ3b3JkX21hdGNoZXMiLCJleGNsdXNpb25zIiwiY3VycmVudF9tYXRjaCIsInN0YXJ0dGltZSIsInByb2Nlc3MiLCJocnRpbWUiLCJmb3JFYWNoIiwicXVlcnkiLCJpbnZlcnQiLCJxdWVyeV9tYXRjaGVzIiwiT2JqZWN0Iiwia2V5cyIsImsiLCJ2IiwicHVzaCIsImludGVyc2VjdGVkX3F1ZXJ5X21hdGNoZXMiLCJzcl9tYXRjaGVzIiwibSIsIm4iLCJzcl9leGNsdXNpb25zIiwibWF0Y2hfaW50ZXJzZWN0aW9uIiwicmFuZ2VfbWF0Y2hlcyIsImxlbmd0aCIsInRlcm1TZWFyY2giLCJwYXJhbXMiLCJkYiIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwid29yZHNfaW5fbWF0Y2hpbmdfcmFuZ2VzX3NldCIsIlNldCIsInJlZHVjZSIsImMiLCJjb25jYXQiLCJhY3R1YWxfbWF0Y2hpbmdfd29yZHNfc2V0IiwicHJvdG90eXBlIiwicmlkbWF0Y2hlcyIsInRoZW4iLCJyaWRNYXRjaFRleHQiLCJyaWQiLCJtYXRjaF9yZXN1bHRfZGF0YSIsInJlc3BvbnNlIiwiY2F0Y2giLCJjb2xsb2NhdGlvblNlYXJjaCIsImdyb3VwaW5nX2tleSIsIndvcmRfbWF0Y2hfbW9ycGgiLCJ3aWQiLCJ0YWxseV9tYXRjaF9kYXRhIiwiaGFzT3duUHJvcGVydHkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxRQUFRLEtBQWQ7QUFD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RUFBVUMsTUFBVixFQUFxQjtBQUFBLHVCQUNkL0IsY0FBYztBQUN0Q0MsZUFBWTBCLE9BQU8sT0FBUCxDQUQwQjtBQUV0Q3pCLGlCQUFjeUIsT0FBTyxjQUFQO0FBRndCLEdBQWQsQ0FEYztBQUFBLE1BQy9CeEIsWUFEK0Isa0JBQy9CQSxZQUQrQjtBQUt2Qzs7O0FBQ0EsTUFBTTZDLG1CQUFrQjdDLGFBQWFQLEdBQWIsQ0FBaUI7QUFBQSxVQUFPLHdCQUFVcUQsR0FBVixFQUFlRixZQUFmLENBQVA7QUFBQSxHQUFqQixDQUF4QjtBQUNBLE1BQU1HLG1CQUFtQkYsaUJBQWlCZCxNQUFqQixDQUF3QixVQUFDQyxDQUFELEVBQUlwQixDQUFKLEVBQVU7QUFDMUQsT0FBSSxDQUFDb0IsRUFBRWdCLGNBQUYsQ0FBaUJwQyxDQUFqQixDQUFMLEVBQ0NvQixFQUFFcEIsQ0FBRixJQUFPLENBQVA7QUFDRG9CLEtBQUVwQixDQUFGO0FBQ0EsVUFBT29CLENBQVA7QUFDQSxHQUx3QixFQUt0QixFQUxzQixDQUF6Qjs7QUFPQSxNQUFNUyxXQUFXO0FBQ2hCLGFBQVUvQixPQUFPQyxJQUFQLENBQVlvQyxnQkFBWixFQUE4QnpCLE1BRHhCO0FBRWhCLGNBQVd5QjtBQUZLLEdBQWpCO0FBSUFwQixVQUFRYyxRQUFSO0FBQ0EsRUFuQk0sQ0FBUDtBQW9CQSxDQXRCRDs7UUF3QlNsQixVLEdBQUFBLFU7UUFBWW9CLGlCLEdBQUFBLGlCIiwiZmlsZSI6InRlcm0tc2VhcmNoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXJyYXlEaWZmLCBhcnJheUludGVyc2VjdCB9IGZyb20gJy4uL3V0aWwvdXRpbCdcbmltcG9ydCB7IHJpZGxpc3RUZXh0IH0gZnJvbSAnLi9jaGFwdGVyLXRleHQnXG5cbmltcG9ydCB3b3JkX2RhdGEgZnJvbSAnLi4vLi4vZGF0YS93b3JkX2RhdGFfbWFwJ1xuaW1wb3J0IHRyZWVfZGF0YSBmcm9tICcuLi8uLi9kYXRhL3RyZWVfZGF0YSdcbmltcG9ydCByYW5nZV9ub2RlX2RhdGEgZnJvbSAnLi4vLi4vZGF0YS9yYW5nZV9ub2RlX2RhdGEnXG5cbmNvbnN0IGRvTG9nID0gZmFsc2VcbmNvbnN0IGNvbnNvbGVMb2cgPSAoLi4uZGVidWcpID0+IHtcblx0aWYgKGRvTG9nKSB7XG5cdFx0Y29uc29sZS5sb2coLi4uZGVidWcpXG5cdH1cbn1cblxuY29uc3QgaGVhdFVwVmVyc2VXb3JkcyA9ICh2ZXJzZV93b3JkcywgaG90X3NldCwgbHVrZXdhcm1fc2V0KSA9PiB7XG5cdHJldHVybiB2ZXJzZV93b3Jkcy5tYXAoYWNjZW50VW5pdCA9PiBcblx0XHRhY2NlbnRVbml0Lm1hcCh3ID0+IHtcblx0XHRcdGlmIChob3Rfc2V0Lmhhcyh3W1wid2lkXCJdKSlcblx0XHRcdFx0d1tcInRlbXBlcmF0dXJlXCJdID0gMlxuXHRcdFx0ZWxzZSBpZiAobHVrZXdhcm1fc2V0Lmhhcyh3W1wid2lkXCJdKSlcblx0XHRcdFx0d1tcInRlbXBlcmF0dXJlXCJdID0gMVxuXHRcdFx0cmV0dXJuIHdcblx0XHR9KVxuXHQpXG59XG5cbmNvbnN0IF9xdWVyeUZvcldpZHMgPSAoe3F1ZXJ5QXJyYXksIHNlYXJjaF9yYW5nZX0pID0+IHtcblx0bGV0IHdvcmRfbWF0Y2hlcyA9IFtdXG5cdGxldCBleGNsdXNpb25zID0gW11cblx0bGV0IGN1cnJlbnRfbWF0Y2ggPSAtMVxuXHRsZXQgc3RhcnR0aW1lID0gcHJvY2Vzcy5ocnRpbWUoKVxuXHRxdWVyeUFycmF5LmZvckVhY2goKHF1ZXJ5KSA9PiB7XG5cdFx0Y29uc29sZUxvZyhcIkJFTkNITUFSSyBROiBmb3JlYWNoIGN5Y2xlIFwiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdGxldCBpbnZlcnQgPSBmYWxzZVxuXHRcdGlmIChcImludmVydFwiIGluIHF1ZXJ5KSB7XG5cdFx0XHRpZiAocXVlcnlbXCJpbnZlcnRcIl0gPT0gXCJ0XCIpIHtcblx0XHRcdFx0aW52ZXJ0ID0gdHJ1ZVxuXHRcdFx0fVxuXHRcdFx0ZGVsZXRlIHF1ZXJ5W1wiaW52ZXJ0XCJdXG5cdFx0fVxuXHRcdGxldCBxdWVyeV9tYXRjaGVzID0gW11cblx0XHRPYmplY3Qua2V5cyhxdWVyeSkuZm9yRWFjaCgoaykgPT4ge1xuXHRcdFx0Y29uc3QgdiA9IHF1ZXJ5W2tdXG5cdFx0XHRxdWVyeV9tYXRjaGVzLnB1c2god29yZF9kYXRhW2tdW3ZdKVxuXHRcdH0pXG5cdFx0Y29uc3QgaW50ZXJzZWN0ZWRfcXVlcnlfbWF0Y2hlcyA9IGFycmF5SW50ZXJzZWN0KC4uLnF1ZXJ5X21hdGNoZXMpXG5cdFx0aWYgKGludmVydClcblx0XHRcdGV4Y2x1c2lvbnMucHVzaCguLi5pbnRlcnNlY3RlZF9xdWVyeV9tYXRjaGVzKVxuXHRcdGVsc2Vcblx0XHRcdHdvcmRfbWF0Y2hlcy5wdXNoKGludGVyc2VjdGVkX3F1ZXJ5X21hdGNoZXMpXG5cdH0pXG5cdGNvbnNvbGVMb2coXCJCRU5DSE1BUksgUTogZG9uZSB3aXRoIGZvcmVhY2hcIiwgcHJvY2Vzcy5ocnRpbWUoc3RhcnR0aW1lKSlcblxuXHRjb25zdCBzcl9tYXRjaGVzID0gd29yZF9tYXRjaGVzLm1hcChtID0+IG0ubWFwKG4gPT4gdHJlZV9kYXRhW25dW3NlYXJjaF9yYW5nZV0pKVxuXHRjb25zdCBzcl9leGNsdXNpb25zID0gZXhjbHVzaW9ucy5tYXAobSA9PiBtLm1hcChuID0+IHRyZWVfZGF0YVtuXVtzZWFyY2hfcmFuZ2VdKSlcblx0Y29uc3QgbWF0Y2hfaW50ZXJzZWN0aW9uID0gYXJyYXlJbnRlcnNlY3QoLi4uc3JfbWF0Y2hlcylcblx0Y29uc3QgcmFuZ2VfbWF0Y2hlcyA9IGFycmF5RGlmZihtYXRjaF9pbnRlcnNlY3Rpb24sIHNyX2V4Y2x1c2lvbnMpXG5cdGNvbnNvbGVMb2coXCJCRU5DSE1BUksgUTogZG9uZSBpbnRlcnNlY3RpbmdcIiwgcHJvY2Vzcy5ocnRpbWUoc3RhcnR0aW1lKSlcblx0Y29uc29sZUxvZyhcIlJFU1VMVFM6XCIsIHJhbmdlX21hdGNoZXMubGVuZ3RoKVxuXHRyZXR1cm4geyB3b3JkX21hdGNoZXMsIHJhbmdlX21hdGNoZXMgfVxufVxuXG5jb25zdCB0ZXJtU2VhcmNoID0gKHBhcmFtcywgZGIpPT4ge1xuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdGxldCBzdGFydHRpbWUgPSBwcm9jZXNzLmhydGltZSgpXG5cdFx0Y29uc29sZUxvZyhcIkJFTkNITUFSSzogc3RhcnRpbmcgbm93XCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0Y29uc3QgeyB3b3JkX21hdGNoZXMsIHJhbmdlX21hdGNoZXMgfSA9IF9xdWVyeUZvcldpZHMoe1xuXHRcdFx0cXVlcnlBcnJheTogcGFyYW1zW1wicXVlcnlcIl0sXG5cdFx0XHRzZWFyY2hfcmFuZ2U6IHBhcmFtc1tcInNlYXJjaF9yYW5nZVwiXSB8fCBcImNsYXVzZVwiXG5cdFx0fSlcblx0XHRjb25zdCB3b3Jkc19pbl9tYXRjaGluZ19yYW5nZXNfc2V0ID0gbmV3IFNldChyYW5nZV9tYXRjaGVzLnJlZHVjZSgoYywgbSkgPT4gYy5jb25jYXQoLi4ucmFuZ2Vfbm9kZV9kYXRhW21dW1wid2lkc1wiXSksIFtdKSlcblx0XHRjb25zb2xlTG9nKFwiQkVOQ0hNQVJLOiBnZXR0aW5nIG1hdGNoaW5nIHdvcmQgc2V0c1wiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdGNvbnN0IGFjdHVhbF9tYXRjaGluZ193b3Jkc19zZXQgPSBuZXcgU2V0KGFycmF5SW50ZXJzZWN0KEFycmF5LnByb3RvdHlwZS5jb25jYXQoLi4ud29yZF9tYXRjaGVzKSwgd29yZHNfaW5fbWF0Y2hpbmdfcmFuZ2VzX3NldCkpXG5cblx0XHRjb25zb2xlTG9nKFwiQkVOQ0hNQVJLOiBub3cgZm9ybXVsYXRpbmcgZmluYWwgZGF0YVwiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdGNvbnN0IHJpZG1hdGNoZXMgPSByYW5nZV9tYXRjaGVzLnJlZHVjZSgoYywgbikgPT4gYy5jb25jYXQoLi4ucmFuZ2Vfbm9kZV9kYXRhW25dW1wicmlkc1wiXSksIFtdKVxuXHRcdHJpZGxpc3RUZXh0KHJpZG1hdGNoZXMsIG5ldyBTZXQoW1wid2xjXCIsIFwibmV0XCJdKSwgZGIpLnRoZW4oKHJpZE1hdGNoVGV4dCkgPT4ge1xuXHRcdFx0T2JqZWN0LmtleXMocmlkTWF0Y2hUZXh0KS5mb3JFYWNoKHJpZCA9PiB7XG5cdFx0XHRcdHJpZE1hdGNoVGV4dFtyaWRdW1wid2xjXCJdID0gaGVhdFVwVmVyc2VXb3Jkcyhcblx0XHRcdFx0XHRyaWRNYXRjaFRleHRbcmlkXVtcIndsY1wiXSxcblx0XHRcdFx0XHRhY3R1YWxfbWF0Y2hpbmdfd29yZHNfc2V0LFxuXHRcdFx0XHRcdHdvcmRzX2luX21hdGNoaW5nX3Jhbmdlc19zZXRcblx0XHRcdFx0KVxuXHRcdFx0fSlcblx0XHRcdGNvbnNvbGVMb2coXCJCRU5DSE1BUks6IHJlc3VsdHMgbm93IGJlaW5nIHByb2Nlc3NlZFwiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdFx0Y29uc3QgbWF0Y2hfcmVzdWx0X2RhdGEgPSByYW5nZV9tYXRjaGVzLm1hcCgobSkgPT4ge1xuXHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdFwibm9kZVwiOiBtLFxuXHRcdFx0XHRcdFwidmVyc2VzXCI6IHJhbmdlX25vZGVfZGF0YVttXVtcInJpZHNcIl0sXG5cdFx0XHRcdFx0XCJ0ZXh0XCI6IHJhbmdlX25vZGVfZGF0YVttXVtcInJpZHNcIl0ubWFwKHJpZCA9PiAoe1tyaWRdOiByaWRNYXRjaFRleHRbcmlkXX0pKVxuXHRcdFx0XHR9XG5cdFx0XHR9KVxuXG5cdFx0XHRjb25zdCByZXNwb25zZSA9IHtcblx0XHRcdFx0XCJsZW5ndGhcIjogbWF0Y2hfcmVzdWx0X2RhdGEubGVuZ3RoLFxuXHRcdFx0XHRcInJlc3VsdHNcIjogbWF0Y2hfcmVzdWx0X2RhdGFcblx0XHRcdH1cblx0XHRcdHJlc29sdmUocmVzcG9uc2UpXG5cdFx0XHRjb25zb2xlTG9nKFwiQkVOQ0hNQVJLOiBkb25lXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0fSkuY2F0Y2goKVxuXHR9KVxufVxuXG5jb25zdCBjb2xsb2NhdGlvblNlYXJjaCA9IChwYXJhbXMpPT4ge1xuXHRjb25zdCBncm91cGluZ19rZXkgPSBcInZvY191dGY4XCJcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRjb25zdCB7IHdvcmRfbWF0Y2hlcyB9ID0gX3F1ZXJ5Rm9yV2lkcyh7XG5cdFx0XHRxdWVyeUFycmF5OiBwYXJhbXNbXCJxdWVyeVwiXSxcblx0XHRcdHNlYXJjaF9yYW5nZTogcGFyYW1zW1wic2VhcmNoX3JhbmdlXCJdXG5cdFx0fSlcblx0XHQvLyBwYXJhbXNbXCJ3aGl0ZWxpc3RcIl0gPT0gW1wiVmVyYlwiXVxuXHRcdGNvbnN0IHdvcmRfbWF0Y2hfbW9ycGg9IHdvcmRfbWF0Y2hlcy5tYXAod2lkID0+IHdvcmRfZGF0YVt3aWRdW2dyb3VwaW5nX2tleV0pXG5cdFx0Y29uc3QgdGFsbHlfbWF0Y2hfZGF0YSA9IHdvcmRfbWF0Y2hfbW9ycGgucmVkdWNlKChjLCBrKSA9PiB7XG5cdFx0XHRpZiAoIWMuaGFzT3duUHJvcGVydHkoaykpXG5cdFx0XHRcdGNba10gPSAwXG5cdFx0XHRjW2tdKytcblx0XHRcdHJldHVybiBjXG5cdFx0fSwge30pXG5cblx0XHRjb25zdCByZXNwb25zZSA9IHtcblx0XHRcdFwibGVuZ3RoXCI6IE9iamVjdC5rZXlzKHRhbGx5X21hdGNoX2RhdGEpLmxlbmd0aCxcblx0XHRcdFwicmVzdWx0c1wiOiB0YWxseV9tYXRjaF9kYXRhXG5cdFx0fVxuXHRcdHJlc29sdmUocmVzcG9uc2UpXG5cdH0pXG59XG5cbmV4cG9ydCB7IHRlcm1TZWFyY2gsIGNvbGxvY2F0aW9uU2VhcmNoIH0iXX0=