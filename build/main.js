'use strict';

var _express = require('express');

var _express2 = _interopRequireDefault(_express);

var _compression = require('compression');

var _compression2 = _interopRequireDefault(_compression);

var _bodyParser = require('body-parser');

var _bodyParser2 = _interopRequireDefault(_bodyParser);

var _cors = require('cors');

var _cors2 = _interopRequireDefault(_cors);

var _chapterText = require('./api/chapter-text');

var _wordLookup = require('./api/word-lookup');

var _termSearch = require('./api/term-search');

var _logging = require('./util/logging');

var _logging2 = _interopRequireDefault(_logging);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var MongoClient = require('mongodb').MongoClient;


var things = {
	mongo: false,
	express: false
};
console.log("WAITING:", Object.keys(things).filter(function (k) {
	return things[k];
}));
var declare_ready = function declare_ready(thing) {
	console.log("READY:", thing);
	things[thing] = true;
	if (Object.keys(things).reduce(function (c, k) {
		return c && things[k];
	}, true)) {
		console.log("READY READY READY!");
	}
};

var mongoConnectionString = process.env.MONGO_CONNECTION_STRING;
var mongoDatabase = process.env.MONGO_DATABASE;
var mongoUrl = 'mongodb://' + mongoConnectionString + '/' + mongoDatabase;

var mongoConnection = null;
MongoClient.connect(mongoUrl, function (err, db) {
	if (err) {
		console.log("Error setting up mongo connection");
		console.log(err);
	} else {
		mongoConnection = db;
		declare_ready("mongo");
	}
});

var app = (0, _express2.default)();
app.use((0, _compression2.default)());
app.use(_bodyParser2.default.json());
app.use((0, _cors2.default)());
var port = +process.env.PORT || 3000;
var host = process.env.HOST || "127.0.0.1";
var server = app.listen(port, host, function () {
	console.log("Server listening to %s:%d within %s environment", host, port, app.get('env'));
	declare_ready("express");
});

console.log("Setting up routes");
app.post(['/api', '/api/*'], function (req, res) {
	var api_request = req.params;
	var params = req.body;
	console.log(api_request[0]);
	(0, _logging2.default)({ api_request: api_request, params: params });

	var responsePromise = new Promise(function (resolve, reject) {
		return resolve();
	});
	switch (api_request[0]) {
		case "term-search":
			responsePromise = (0, _termSearch.termSearch)(params, mongoConnection);
			break;
		case "collocation-search":
			responsePromise = (0, _termSearch.collocationSearch)(params);
			// response = termSearch(params) 
			break;
		case "word-study":
			// response = termSearch(params) 
			break;
		case "word-lookup":
			responsePromise = (0, _wordLookup.wordLookup)(params, mongoConnection);
			break;
		case "term-highlights":
			// response = termSearch(params) 
			break;
		case "chapter-text":
			responsePromise = (0, _chapterText.chapterText)(params, mongoConnection);
			break;
		default:
			responsePromise = new Promise(function (resolve, reject) {
				reject({
					"error": "Invalid api request. Request should be formatted /api/<type of request>",
					"options": ["term-search", "collocation-search", "word-study", "word-lookup", "term-highlights", "chapter-text"]
				});
			});
			break;
	}
	responsePromise.then(function (response) {
		res.send(response);
	}).catch(function (response) {
		res.send(response);
		console.log("error");
		console.log(response);
	});
});

var clientRoot = process.env.PARABIBLE_CLIENT_DIR;
var getUrl = function getUrl(mobile) {
	if (mobile) return '/mobile.html';else return '/index.html';
};
var needsFonts = function needsFonts(userAgent) {
	// technically this is not mobile - it's whether or not to dump fonts into the index.html
	var regexForMobile = {
		// Windows: /windows nt/i,
		WindowsPhone: /windows phone/i,
		// Mac: /macintosh/i,
		// Linux: /linux/i,
		Wii: /wii/i,
		Playstation: /playstation/i,
		iPad: /ipad/i,
		iPod: /ipod/i,
		iPhone: /iphone/i,
		Android: /android/i,
		Blackberry: /blackberry/i,
		Samsung: /samsung/i,
		// Curl: /curl/i
		Mobile: /mobile/i
	};
	return Object.keys(regexForMobile).reduce(function (a, k) {
		return a || regexForMobile[k].test(userAgent);
	}, false);
};

// Route order matters - the first listed will be invoked
app.get("/", function (req, res) {
	res.sendFile(getUrl(needsFonts(req.headers["user-agent"])), { root: clientRoot });
});
app.use(_express2.default.static(clientRoot));
app.get("*", function (req, res) {
	res.sendFile(getUrl(needsFonts(req.headers["user-agent"])), { root: clientRoot });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLmpzIl0sIm5hbWVzIjpbIk1vbmdvQ2xpZW50IiwicmVxdWlyZSIsInRoaW5ncyIsIm1vbmdvIiwiZXhwcmVzcyIsImNvbnNvbGUiLCJsb2ciLCJPYmplY3QiLCJrZXlzIiwiZmlsdGVyIiwiayIsImRlY2xhcmVfcmVhZHkiLCJ0aGluZyIsInJlZHVjZSIsImMiLCJtb25nb0Nvbm5lY3Rpb25TdHJpbmciLCJwcm9jZXNzIiwiZW52IiwiTU9OR09fQ09OTkVDVElPTl9TVFJJTkciLCJtb25nb0RhdGFiYXNlIiwiTU9OR09fREFUQUJBU0UiLCJtb25nb1VybCIsIm1vbmdvQ29ubmVjdGlvbiIsImNvbm5lY3QiLCJlcnIiLCJkYiIsImFwcCIsInVzZSIsImpzb24iLCJwb3J0IiwiUE9SVCIsImhvc3QiLCJIT1NUIiwic2VydmVyIiwibGlzdGVuIiwiZ2V0IiwicG9zdCIsInJlcSIsInJlcyIsImFwaV9yZXF1ZXN0IiwicGFyYW1zIiwiYm9keSIsInJlc3BvbnNlUHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwidGhlbiIsInJlc3BvbnNlIiwic2VuZCIsImNhdGNoIiwiY2xpZW50Um9vdCIsIlBBUkFCSUJMRV9DTElFTlRfRElSIiwiZ2V0VXJsIiwibW9iaWxlIiwibmVlZHNGb250cyIsInVzZXJBZ2VudCIsInJlZ2V4Rm9yTW9iaWxlIiwiV2luZG93c1Bob25lIiwiV2lpIiwiUGxheXN0YXRpb24iLCJpUGFkIiwiaVBvZCIsImlQaG9uZSIsIkFuZHJvaWQiLCJCbGFja2JlcnJ5IiwiU2Ftc3VuZyIsIk1vYmlsZSIsImEiLCJ0ZXN0Iiwic2VuZEZpbGUiLCJoZWFkZXJzIiwicm9vdCIsInN0YXRpYyJdLCJtYXBwaW5ncyI6Ijs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOztBQUNBOztBQUNBOztBQUVBOzs7Ozs7QUFWQSxJQUFJQSxjQUFjQyxRQUFRLFNBQVIsRUFBbUJELFdBQXJDOzs7QUFZQSxJ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QUFZLGFBWFU7QUFZdEJDLFdBQVMsVUFaYTtBQWF0QjtBQUNBQyxVQUFRO0FBZGMsRUFBdkI7QUFnQkEsUUFBTzNELE9BQU9DLElBQVAsQ0FBWWdELGNBQVosRUFBNEIzQyxNQUE1QixDQUFtQyxVQUFDc0QsQ0FBRCxFQUFJekQsQ0FBSjtBQUFBLFNBQ3pDeUQsS0FBS1gsZUFBZTlDLENBQWYsRUFBa0IwRCxJQUFsQixDQUF1QmIsU0FBdkIsQ0FEb0M7QUFBQSxFQUFuQyxFQUVQLEtBRk8sQ0FBUDtBQUdBLENBckJEOztBQXVCQTtBQUNBN0IsSUFBSVMsR0FBSixDQUFRLEdBQVIsRUFBYSxVQUFDRSxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUMxQkEsS0FBSStCLFFBQUosQ0FBYWpCLE9BQU9FLFdBQVdqQixJQUFJaUMsT0FBSixDQUFZLFlBQVosQ0FBWCxDQUFQLENBQWIsRUFBNEQsRUFBQ0MsTUFBTXJCLFVBQVAsRUFBNUQ7QUFDQSxDQUZEO0FBR0F4QixJQUFJQyxHQUFKLENBQVEsa0JBQVE2QyxNQUFSLENBQWV0QixVQUFmLENBQVI7QUFDQXhCLElBQUlTLEdBQUosQ0FBUSxHQUFSLEVBQWEsVUFBQ0UsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDMUJBLEtBQUkrQixRQUFKLENBQWFqQixPQUFPRSxXQUFXakIsSUFBSWlDLE9BQUosQ0FBWSxZQUFaLENBQVgsQ0FBUCxDQUFiLEVBQTRELEVBQUNDLE1BQU1yQixVQUFQLEVBQTVEO0FBQ0EsQ0FGRCIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIE1vbmdvQ2xpZW50ID0gcmVxdWlyZSgnbW9uZ29kYicpLk1vbmdvQ2xpZW50XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJ1xuaW1wb3J0IGNvbXByZXNzaW9uIGZyb20gJ2NvbXByZXNzaW9uJ1xuaW1wb3J0IGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInXG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJ1xuXG5pbXBvcnQgeyBjaGFwdGVyVGV4dCB9IGZyb20gXCIuL2FwaS9jaGFwdGVyLXRleHRcIlxuaW1wb3J0IHsgd29yZExvb2t1cCB9IGZyb20gXCIuL2FwaS93b3JkLWxvb2t1cFwiXG5pbXBvcnQgeyB0ZXJtU2VhcmNoLCBjb2xsb2NhdGlvblNlYXJjaCB9IGZyb20gXCIuL2FwaS90ZXJtLXNlYXJjaFwiXG5cbmltcG9ydCBMb2cgZnJvbSBcIi4vdXRpbC9sb2dnaW5nXCJcblxubGV0IHRoaW5ncyA9IHtcblx0bW9uZ286IGZhbHNlLFxuXHRleHByZXNzOiBmYWxzZVxufVxuY29uc29sZS5sb2coXCJXQUlUSU5HOlwiLCBPYmplY3Qua2V5cyh0aGluZ3MpLmZpbHRlcihrID0+IHRoaW5nc1trXSkpXG5jb25zdCBkZWNsYXJlX3JlYWR5ID0gKHRoaW5nKSA9PiB7XG5cdGNvbnNvbGUubG9nKFwiUkVBRFk6XCIsIHRoaW5nKVxuXHR0aGluZ3NbdGhpbmddID0gdHJ1ZVxuXHRpZiAoT2JqZWN0LmtleXModGhpbmdzKS5yZWR1Y2UoKGMsIGspID0+IGMgJiYgdGhpbmdzW2tdLCB0cnVlKSkge1xuXHRcdGNvbnNvbGUubG9nKFwiUkVBRFkgUkVBRFkgUkVBRFkhXCIpXG5cdH1cbn1cblxuY29uc3QgbW9uZ29Db25uZWN0aW9uU3RyaW5nID0gcHJvY2Vzcy5lbnYuTU9OR09fQ09OTkVDVElPTl9TVFJJTkdcbmNvbnN0IG1vbmdvRGF0YWJhc2UgPSBwcm9jZXNzLmVudi5NT05HT19EQVRBQkFTRVxuY29uc3QgbW9uZ29VcmwgPSBgbW9uZ29kYjovLyR7bW9uZ29Db25uZWN0aW9uU3RyaW5nfS8ke21vbmdvRGF0YWJhc2V9YFxuXG5sZXQgbW9uZ29Db25uZWN0aW9uID0gbnVsbDtcbk1vbmdvQ2xpZW50LmNvbm5lY3QobW9uZ29VcmwsIChlcnIsIGRiKSA9PiB7XG5cdGlmIChlcnIpIHtcblx0XHRjb25zb2xlLmxvZyhcIkVycm9yIHNldHRpbmcgdXAgbW9uZ28gY29ubmVjdGlvblwiKVxuXHRcdGNvbnNvbGUubG9nKGVycilcblx0fVxuXHRlbHNlIHtcblx0XHRtb25nb0Nvbm5lY3Rpb24gPSBkYlxuXHRcdGRlY2xhcmVfcmVhZHkoXCJtb25nb1wiKVxuXHR9XG59KVxuXG5sZXQgYXBwID0gZXhwcmVzcygpXG5hcHAudXNlKGNvbXByZXNzaW9uKCkpXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKVxuYXBwLnVzZShjb3JzKCkpXG5sZXQgcG9ydCA9ICtwcm9jZXNzLmVudi5QT1JUIHx8IDMwMDBcbmxldCBob3N0ID0gcHJvY2Vzcy5lbnYuSE9TVCB8fCBcIjEyNy4wLjAuMVwiXG5sZXQgc2VydmVyID0gYXBwLmxpc3Rlbihwb3J0LCBob3N0LCAoKSA9PiB7XG5cdGNvbnNvbGUubG9nKFwiU2VydmVyIGxpc3RlbmluZyB0byAlczolZCB3aXRoaW4gJXMgZW52aXJvbm1lbnRcIiwgaG9zdCwgcG9ydCwgYXBwLmdldCgnZW52JykpXG5cdGRlY2xhcmVfcmVhZHkoXCJleHByZXNzXCIpXG59KVxuXG5cblxuY29uc29sZS5sb2coXCJTZXR0aW5nIHVwIHJvdXRlc1wiKVxuYXBwLnBvc3QoWycvYXBpJywgJy9hcGkvKiddLCAocmVxLCByZXMpID0+IHtcblx0Y29uc3QgYXBpX3JlcXVlc3QgPSByZXEucGFyYW1zXG5cdGNvbnN0IHBhcmFtcyA9IHJlcS5ib2R5XG5cdGNvbnNvbGUubG9nKGFwaV9yZXF1ZXN0WzBdKVxuXHRMb2coeyBhcGlfcmVxdWVzdCwgcGFyYW1zIH0pXG5cblx0bGV0IHJlc3BvbnNlUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHJlc29sdmUoKSlcblx0c3dpdGNoKGFwaV9yZXF1ZXN0WzBdKSB7XG5cdFx0Y2FzZSBcInRlcm0tc2VhcmNoXCI6XG5cdFx0XHRyZXNwb25zZVByb21pc2UgPSB0ZXJtU2VhcmNoKHBhcmFtcywgbW9uZ29Db25uZWN0aW9uKVxuXHRcdFx0YnJlYWtcblx0XHRjYXNlIFwiY29sbG9jYXRpb24tc2VhcmNoXCI6XG5cdFx0XHRyZXNwb25zZVByb21pc2UgPSBjb2xsb2NhdGlvblNlYXJjaChwYXJhbXMpXG5cdFx0XHQvLyByZXNwb25zZSA9IHRlcm1TZWFyY2gocGFyYW1zKSBcblx0XHRcdGJyZWFrXG5cdFx0Y2FzZSBcIndvcmQtc3R1ZHlcIjpcblx0XHRcdC8vIHJlc3BvbnNlID0gdGVybVNlYXJjaChwYXJhbXMpIFxuXHRcdFx0YnJlYWtcblx0XHRjYXNlIFwid29yZC1sb29rdXBcIjpcblx0XHRcdHJlc3BvbnNlUHJvbWlzZSA9IHdvcmRMb29rdXAocGFyYW1zLCBtb25nb0Nvbm5lY3Rpb24pIFxuXHRcdFx0YnJlYWtcblx0XHRjYXNlIFwidGVybS1oaWdobGlnaHRzXCI6XG5cdFx0XHQvLyByZXNwb25zZSA9IHRlcm1TZWFyY2gocGFyYW1zKSBcblx0XHRcdGJyZWFrXG5cdFx0Y2FzZSBcImNoYXB0ZXItdGV4dFwiOlxuXHRcdFx0cmVzcG9uc2VQcm9taXNlID0gY2hhcHRlclRleHQocGFyYW1zLCBtb25nb0Nvbm5lY3Rpb24pXG5cdFx0XHRicmVha1xuXHRcdGRlZmF1bHQ6XG5cdFx0XHRyZXNwb25zZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHRcdHJlamVjdCh7XG5cdFx0XHRcdFx0XCJlcnJvclwiOiBcIkludmFsaWQgYXBpIHJlcXVlc3QuIFJlcXVlc3Qgc2hvdWxkIGJlIGZvcm1hdHRlZCAvYXBpLzx0eXBlIG9mIHJlcXVlc3Q+XCIsXG5cdFx0XHRcdFx0XCJvcHRpb25zXCI6IFtcblx0XHRcdFx0XHRcdFwidGVybS1zZWFyY2hcIixcblx0XHRcdFx0XHRcdFwiY29sbG9jYXRpb24tc2VhcmNoXCIsXG5cdFx0XHRcdFx0XHRcIndvcmQtc3R1ZHlcIixcblx0XHRcdFx0XHRcdFwid29yZC1sb29rdXBcIixcblx0XHRcdFx0XHRcdFwidGVybS1oaWdobGlnaHRzXCIsXG5cdFx0XHRcdFx0XHRcImNoYXB0ZXItdGV4dFwiXG5cdFx0XHRcdFx0XVxuXHRcdFx0XHR9KVxuXHRcdFx0fSlcblx0XHRcdGJyZWFrXG5cdH1cblx0cmVzcG9uc2VQcm9taXNlLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG5cdFx0cmVzLnNlbmQocmVzcG9uc2UpXG5cdH0pLmNhdGNoKChyZXNwb25zZSkgPT4ge1xuXHRcdHJlcy5zZW5kKHJlc3BvbnNlKVxuXHRcdGNvbnNvbGUubG9nKFwiZXJyb3JcIilcblx0XHRjb25zb2xlLmxvZyhyZXNwb25zZSlcblx0fSlcbn0pXG5cblxuY29uc3QgY2xpZW50Um9vdCA9IHByb2Nlc3MuZW52LlBBUkFCSUJMRV9DTElFTlRfRElSXG5jb25zdCBnZXRVcmwgPSAobW9iaWxlKSA9PiB7XG5cdGlmIChtb2JpbGUpXG5cdFx0cmV0dXJuICcvbW9iaWxlLmh0bWwnXG5cdGVsc2Vcblx0XHRyZXR1cm4gJy9pbmRleC5odG1sJ1xufVxuY29uc3QgbmVlZHNGb250cyA9ICh1c2VyQWdlbnQpID0+IHtcblx0Ly8gdGVjaG5pY2FsbHkgdGhpcyBpcyBub3QgbW9iaWxlIC0gaXQncyB3aGV0aGVyIG9yIG5vdCB0byBkdW1wIGZvbnRzIGludG8gdGhlIGluZGV4Lmh0bWxcblx0Y29uc3QgcmVnZXhGb3JNb2JpbGUgPSB7XG5cdFx0Ly8gV2luZG93czogL3dpbmRvd3MgbnQvaSxcblx0XHRXaW5kb3dzUGhvbmU6IC93aW5kb3dzIHBob25lL2ksXG5cdFx0Ly8gTWFjOiAvbWFjaW50b3NoL2ksXG5cdFx0Ly8gTGludXg6IC9saW51eC9pLFxuXHRcdFdpaTogL3dpaS9pLFxuXHRcdFBsYXlzdGF0aW9uOiAvcGxheXN0YXRpb24vaSxcblx0XHRpUGFkOiAvaXBhZC9pLFxuXHRcdGlQb2Q6IC9pcG9kL2ksXG5cdFx0aVBob25lOiAvaXBob25lL2ksXG5cdFx0QW5kcm9pZDogL2FuZHJvaWQvaSxcblx0XHRCbGFja2JlcnJ5OiAvYmxhY2tiZXJyeS9pLFxuXHRcdFNhbXN1bmc6IC9zYW1zdW5nL2ksXG5cdFx0Ly8gQ3VybDogL2N1cmwvaVxuXHRcdE1vYmlsZTogL21vYmlsZS9pXG5cdH1cblx0cmV0dXJuIE9iamVjdC5rZXlzKHJlZ2V4Rm9yTW9iaWxlKS5yZWR1Y2UoKGEsIGspID0+XG5cdFx0YSB8fCByZWdleEZvck1vYmlsZVtrXS50ZXN0KHVzZXJBZ2VudCksXG5cdGZhbHNlKVxufVxuXG4vLyBSb3V0ZSBvcmRlciBtYXR0ZXJzIC0gdGhlIGZpcnN0IGxpc3RlZCB3aWxsIGJlIGludm9rZWRcbmFwcC5nZXQoXCIvXCIsIChyZXEsIHJlcykgPT4ge1xuXHRyZXMuc2VuZEZpbGUoZ2V0VXJsKG5lZWRzRm9udHMocmVxLmhlYWRlcnNbXCJ1c2VyLWFnZW50XCJdKSksIHtyb290OiBjbGllbnRSb290fSlcbn0pXG5hcHAudXNlKGV4cHJlc3Muc3RhdGljKGNsaWVudFJvb3QpKVxuYXBwLmdldChcIipcIiwgKHJlcSwgcmVzKSA9PiB7XG5cdHJlcy5zZW5kRmlsZShnZXRVcmwobmVlZHNGb250cyhyZXEuaGVhZGVyc1tcInVzZXItYWdlbnRcIl0pKSwge3Jvb3Q6IGNsaWVudFJvb3R9KVxufSkiXX0=