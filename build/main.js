'use strict';

var _express = require('express');

var _express2 = _interopRequireDefault(_express);

var _compression = require('compression');

var _compression2 = _interopRequireDefault(_compression);

var _bodyParser = require('body-parser');

var _bodyParser2 = _interopRequireDefault(_bodyParser);

var _cors = require('cors');

var _cors2 = _interopRequireDefault(_cors);

var _chapterText = require('./api/chapter-text');

var _wordLookup = require('./api/word-lookup');

var _termSearch = require('./api/term-search');

var _logging = require('./util/logging');

var _logging2 = _interopRequireDefault(_logging);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var MongoClient = require('mongodb').MongoClient;


var things = {
	mongo: false,
	express: false
};
console.log("WAITING:", Object.keys(things).filter(function (k) {
	return things[k];
}));
var declare_ready = function declare_ready(thing) {
	console.log("READY:", thing);
	things[thing] = true;
	if (Object.keys(things).reduce(function (c, k) {
		return c && things[k];
	}, true)) {
		console.log("READY READY READY!");
	}
};

var mongoConnectionString = process.env.MONGO_CONNECTION_STRING;
var mongoDatabase = process.env.MONGO_DATABASE;
var mongoUrl = 'mongodb://' + mongoConnectionString + '/' + mongoDatabase;

var mongoConnection = null;
MongoClient.connect(mongoUrl, function (err, db) {
	if (err) {
		console.log("Error setting up mongo connection");
		console.log(err);
	} else {
		mongoConnection = db;
		declare_ready("mongo");
	}
});

var app = (0, _express2.default)();
app.use((0, _compression2.default)());
app.use(_bodyParser2.default.json());
app.use((0, _cors2.default)());
var port = +process.env.PORT || 3000;
var host = process.env.HOST || "127.0.0.1";
var server = app.listen(port, host, function () {
	console.log("Server listening to %s:%d within %s environment", host, port, app.get('env'));
	declare_ready("express");
});

// Use X-Forwarded-For
app.set('trust proxy', 'loopback');

console.log("Setting up routes");
app.post(['/api', '/api/*'], function (req, res) {
	var api_request = req.params;
	var params = req.body;
	console.log(api_request[0]);
	(0, _logging2.default)({ api_request: api_request, params: params, ip_address: req.ip });

	var responsePromise = new Promise(function (resolve, reject) {
		return resolve();
	});
	switch (api_request[0]) {
		case "term-search":
			responsePromise = (0, _termSearch.termSearch)(params, mongoConnection);
			break;
		case "collocation-search":
			responsePromise = (0, _termSearch.collocationSearch)(params);
			// response = termSearch(params) 
			break;
		case "word-study":
			// response = termSearch(params) 
			break;
		case "word-lookup":
			responsePromise = (0, _wordLookup.wordLookup)(params, mongoConnection);
			break;
		case "term-highlights":
			// response = termSearch(params) 
			break;
		case "chapter-text":
			responsePromise = (0, _chapterText.chapterText)(params, mongoConnection);
			break;
		default:
			responsePromise = new Promise(function (resolve, reject) {
				reject({
					"error": "Invalid api request. Request should be formatted /api/<type of request>",
					"options": ["term-search", "collocation-search", "word-study", "word-lookup", "term-highlights", "chapter-text"]
				});
			});
			break;
	}
	responsePromise.then(function (response) {
		res.send(response);
	}).catch(function (response) {
		res.send(response);
		console.log("error");
		console.log(response);
	});
});

var clientRoot = process.env.PARABIBLE_CLIENT_DIR;
var getUrl = function getUrl(mobile) {
	if (mobile) return '/mobile.html';else return '/index.html';
};
var needsFonts = function needsFonts(userAgent) {
	// technically this is not mobile - it's whether or not to dump fonts into the index.html
	var regexForMobile = {
		// Windows: /windows nt/i,
		WindowsPhone: /windows phone/i,
		// Mac: /macintosh/i,
		// Linux: /linux/i,
		Wii: /wii/i,
		Playstation: /playstation/i,
		iPad: /ipad/i,
		iPod: /ipod/i,
		iPhone: /iphone/i,
		Android: /android/i,
		Blackberry: /blackberry/i,
		Samsung: /samsung/i,
		// Curl: /curl/i
		Mobile: /mobile/i
	};
	return Object.keys(regexForMobile).reduce(function (a, k) {
		return a || regexForMobile[k].test(userAgent);
	}, false);
};

// Route order matters - the first listed will be invoked
app.get("/", function (req, res) {
	res.sendFile(getUrl(needsFonts(req.headers["user-agent"])), { root: clientRoot });
});
app.use(_express2.default.static(clientRoot));
app.get("*", function (req, res) {
	res.sendFile(getUrl(needsFonts(req.headers["user-agent"])), { root: clientRoot });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLmpzIl0sIm5hbWVzIjpbIk1vbmdvQ2xpZW50IiwicmVxdWlyZSIsInRoaW5ncyIsIm1vbmdvIiwiZXhwcmVzcyIsImNvbnNvbGUiLCJsb2ciLCJPYmplY3QiLCJrZXlzIiwiZmlsdGVyIiwiayIsImRlY2xhcmVfcmVhZHkiLCJ0aGluZyIsInJlZHVjZSIsImMiLCJtb25nb0Nvbm5lY3Rpb25TdHJpbmciLCJwcm9jZXNzIiwiZW52IiwiTU9OR09fQ09OTkVDVElPTl9TVFJJTkciLCJtb25nb0RhdGFiYXNlIiwiTU9OR09fREFUQUJBU0UiLCJtb25nb1VybCIsIm1vbmdvQ29ubmVjdGlvbiIsImNvbm5lY3QiLCJlcnIiLCJkYiIsImFwcCIsInVzZSIsImpzb24iLCJwb3J0IiwiUE9SVCIsImhvc3QiLCJIT1NUIiwic2VydmVyIiwibGlzdGVuIiwiZ2V0Iiwic2V0IiwicG9zdCIsInJlcSIsInJlcyIsImFwaV9yZXF1ZXN0IiwicGFyYW1zIiwiYm9keSIsImlwX2FkZHJlc3MiLCJpcCIsInJlc3BvbnNlUHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwidGhlbiIsInJlc3BvbnNlIiwic2VuZCIsImNhdGNoIiwiY2xpZW50Um9vdCIsIlBBUkFCSUJMRV9DTElFTlRfRElSIiwiZ2V0VXJsIiwibW9iaWxlIiwibmVlZHNGb250cyIsInVzZXJBZ2VudCIsInJlZ2V4Rm9yTW9iaWxlIiwiV2luZG93c1Bob25lIiwiV2lpIiwiUGxheXN0YXRpb24iLCJpUGFkIiwiaVBvZCIsImlQaG9uZSIsIkFuZHJvaWQiLCJCbGFja2JlcnJ5IiwiU2Ftc3VuZyIsIk1vYmlsZSIsImEiLCJ0ZXN0Iiwic2VuZEZpbGUiLCJoZWFkZXJzIiwicm9vdCIsInN0YXRpYyJdLCJtYXBwaW5ncyI6Ijs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOztBQUNBOztBQUNBOztBQUVBOzs7Ozs7QUFWQSxJQUFJQSxjQUFjQyxRQUFRLFNBQVIsRUFBbUJELFdBQXJDOzs7QUFZQSxJQUFJRSxTQUFTO0FBQ1pDLFFBQU8sS0FESztBQUVaQyxVQUFTO0FBRkcsQ0FBYjtBQUlBQyxRQUFRQyxHQUFSLENBQVksVUFBWixFQUF3QkMsT0FBT0MsSUFBUCxDQUFZTixNQUFaLEVBQW9CTyxNQUFwQixDQUEyQjtBQUFBLFFBQUtQLE9BQU9RLENBQVAsQ0FBTDtBQUFBLENBQTNCLENBQXhCO0FBQ0EsSUFBTUMsZ0JBQWdCLFNBQWhCQSxhQUFnQixDQUFDQyxLQUFELEVBQVc7QUFDaENQLFNBQVFDLEdBQVIsQ0FBWSxRQUFaLEVBQXNCTSxLQUF0QjtBQUNBVixRQUFPVSxLQUFQLElBQWdCLElBQWhCO0FBQ0EsS0FBSUwsT0FBT0MsSUFBUCxDQUFZTixNQUFaLEVBQW9CVyxNQUFwQixDQUEyQixVQUFDQyxDQUFELEVBQUlKLENBQUo7QUFBQSxTQUFVSSxLQUFLWixPQUFPUSxDQUFQLENBQWY7QUFBQSxFQUEzQixFQUFxRCxJQUFyRCxDQUFKLEVBQWdFO0FBQy9ETCxVQUFRQyxHQUFSLENBQVksb0JBQVo7QUFDQTtBQUNELENBTkQ7O0FBUUEsSUFBTVMsd0JBQXdCQyxRQUFRQyxHQUFSLENBQVlDLHVCQUExQztBQUNBLElBQU1DLGdCQUFnQkgsUUFBUUMsR0FBUixDQUFZRyxjQUFsQztBQUNBLElBQU1DLDBCQUF3Qk4scUJBQXhCLFNBQWlESSxhQUF2RDs7QUFFQSxJQUFJRyxrQkFBa0IsSUFBdEI7QUFDQXRCLFlBQVl1QixPQUFaLENBQW9CRixRQUFwQixFQUE4QixVQUFDRyxHQUFELEVBQU1DLEVBQU4sRUFBYTtBQUMxQyxLQUFJRCxHQUFKLEVBQVM7QUFDUm5CLFVBQVFDLEdBQVIsQ0FBWSxtQ0FBWjtBQUNBRCxVQUFRQyxHQUFSLENBQVlrQixHQUFaO0FBQ0EsRUFIRCxNQUlLO0FBQ0pGLG9CQUFrQkcsRUFBbEI7QUFDQWQsZ0JBQWMsT0FBZDtBQUNBO0FBQ0QsQ0FURDs7QUFXQSxJQUFJZSxNQUFNLHdCQUFWO0FBQ0FBLElBQUlDLEdBQUosQ0FBUSw0QkFBUjtBQUNBRCxJQUFJQyxHQUFKLENBQVEscUJBQVdDLElBQVgsRUFBUjtBQUNBRixJQUFJQyxHQUFKLENBQVEscUJBQVI7QUFDQSxJQUFJRSxPQUFPLENBQUNiLFFBQVFDLEdBQVIsQ0FBWWEsSUFBYixJQUFxQixJQUFoQztBQUNBLElBQUlDLE9BQU9mLFFBQVFDLEdBQVIsQ0FBWWUsSUFBWixJQUFvQixXQUEvQjtBQUNBLElBQUlDLFNBQVNQLElBQUlRLE1BQUosQ0FBV0wsSUFBWCxFQUFpQkUsSUFBakIsRUFBdUIsWUFBTTtBQUN6QzFCLFNBQVFDLEdBQVIsQ0FBWSxpREFBWixFQUErRHlCLElBQS9ELEVBQXFFRixJQUFyRSxFQUEyRUgsSUFBSVMsR0FBSixDQUFRLEtBQVIsQ0FBM0U7QUFDQXhCLGVBQWMsU0FBZDtBQUNBLENBSFksQ0FBYjs7QUFLQTtBQUNBZSxJQUFJVSxHQUFKLENBQVEsYUFBUixFQUF1QixVQUF2Qjs7QUFHQS9CLFFBQVFDLEdBQVIsQ0FBWSxtQkFBWjtBQUNBb0IsSUFBSVcsSUFBSixDQUFTLENBQUMsTUFBRCxFQUFTLFFBQVQsQ0FBVCxFQUE2QixVQUFDQyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUMxQyxLQUFNQyxjQUFjRixJQUFJRyxNQUF4QjtBQUNBLEtBQU1BLFNBQVNILElBQUlJLElBQW5CO0FBQ0FyQyxTQUFRQyxHQUFSLENBQVlrQyxZQUFZLENBQVosQ0FBWjtBQUNBLHdCQUFJLEVBQUVBLHdCQUFGLEVBQWVDLGNBQWYsRUFBdUJFLFlBQVlMLElBQUlNLEVBQXZDLEVBQUo7O0FBRUEsS0FBSUMsa0JBQWtCLElBQUlDLE9BQUosQ0FBWSxVQUFDQyxPQUFELEVBQVVDLE1BQVY7QUFBQSxTQUFxQkQsU0FBckI7QUFBQSxFQUFaLENBQXRCO0FBQ0EsU0FBT1AsWUFBWSxDQUFaLENBQVA7QUFDQyxPQUFLLGFBQUw7QUFDQ0sscUJBQWtCLDRCQUFXSixNQUFYLEVBQW1CbkIsZUFBbkIsQ0FBbEI7QUFDQTtBQUNELE9BQUssb0JBQUw7QUFDQ3VCLHFCQUFrQixtQ0FBa0JKLE1BQWxCLENBQWxCO0FBQ0E7QUFDQTtBQUNELE9BQUssWUFBTDtBQUNDO0FBQ0E7QUFDRCxPQUFLLGFBQUw7QUFDQ0kscUJBQWtCLDRCQUFXSixNQUFYLEVBQW1CbkIsZUFBbkIsQ0FBbEI7QUFDQTtBQUNELE9BQUssaUJBQUw7QUFDQztBQUNBO0FBQ0QsT0FBSyxjQUFMO0FBQ0N1QixxQkFBa0IsOEJBQVlKLE1BQVosRUFBb0JuQixlQUFwQixDQUFsQjtBQUNBO0FBQ0Q7QUFDQ3VCLHFCQUFrQixJQUFJQyxPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQ2xEQSxXQUFPO0FBQ04sY0FBUyx5RUFESDtBQUVOLGdCQUFXLENBQ1YsYUFEVSxFQUVWLG9CQUZVLEVBR1YsWUFIVSxFQUlWLGFBSlUsRUFLVixpQkFMVSxFQU1WLGNBTlU7QUFGTCxLQUFQO0FBV0EsSUFaaUIsQ0FBbEI7QUFhQTtBQWxDRjtBQW9DQUgsaUJBQWdCSSxJQUFoQixDQUFxQixVQUFDQyxRQUFELEVBQWM7QUFDbENYLE1BQUlZLElBQUosQ0FBU0QsUUFBVDtBQUNBLEVBRkQsRUFFR0UsS0FGSCxDQUVTLFVBQUNGLFFBQUQsRUFBYztBQUN0QlgsTUFBSVksSUFBSixDQUFTRCxRQUFUO0FBQ0E3QyxVQUFRQyxHQUFSLENBQVksT0FBWjtBQUNBRCxVQUFRQyxHQUFSLENBQVk0QyxRQUFaO0FBQ0EsRUFORDtBQU9BLENBbEREOztBQXFEQSxJQUFNRyxhQUFhckMsUUFBUUMsR0FBUixDQUFZcUMsb0JBQS9CO0FBQ0EsSUFBTUMsU0FBUyxTQUFUQSxNQUFTLENBQUNDLE1BQUQsRUFBWTtBQUMxQixLQUFJQSxNQUFKLEVBQ0MsT0FBTyxjQUFQLENBREQsS0FHQyxPQUFPLGFBQVA7QUFDRCxDQUxEO0FBTUEsSUFBTUMsYUFBYSxTQUFiQSxVQUFhLENBQUNDLFNBQUQsRUFBZTtBQUNqQztBQUNBLEtBQU1DLGlCQUFpQjtBQUN0QjtBQUNBQyxnQkFBYyxnQkFGUTtBQUd0QjtBQUNBO0FBQ0FDLE9BQUssTUFMaUI7QUFNdEJDLGVBQWEsY0FOUztBQU90QkMsUUFBTSxPQVBnQjtBQVF0QkMsUUFBTSxPQVJnQjtBQVN0QkMsVUFBUSxTQVRjO0FBVXRCQyxXQUFTLFVBVmE7QUFXdEJDLGNBQVksYUFYVTtBQVl0QkMsV0FBUyxVQVphO0FBYXRCO0FBQ0FDLFVBQVE7QUFkYyxFQUF2QjtBQWdCQSxRQUFPOUQsT0FBT0MsSUFBUCxDQUFZbUQsY0FBWixFQUE0QjlDLE1BQTVCLENBQW1DLFVBQUN5RCxDQUFELEVBQUk1RCxDQUFKO0FBQUEsU0FDekM0RCxLQUFLWCxlQUFlakQsQ0FBZixFQUFrQjZELElBQWxCLENBQXVCYixTQUF2QixDQURvQztBQUFBLEVBQW5DLEVBRVAsS0FGTyxDQUFQO0FBR0EsQ0FyQkQ7O0FBdUJBO0FBQ0FoQyxJQUFJUyxHQUFKLENBQVEsR0FBUixFQUFhLFVBQUNHLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQzFCQSxLQUFJaUMsUUFBSixDQUFhakIsT0FBT0UsV0FBV25CLElBQUltQyxPQUFKLENBQVksWUFBWixDQUFYLENBQVAsQ0FBYixFQUE0RCxFQUFDQyxNQUFNckIsVUFBUCxFQUE1RDtBQUNBLENBRkQ7QUFHQTNCLElBQUlDLEdBQUosQ0FBUSxrQkFBUWdELE1BQVIsQ0FBZXRCLFVBQWYsQ0FBUjtBQUNBM0IsSUFBSVMsR0FBSixDQUFRLEdBQVIsRUFBYSxVQUFDRyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUMxQkEsS0FBSWlDLFFBQUosQ0FBYWpCLE9BQU9FLFdBQVduQixJQUFJbUMsT0FBSixDQUFZLFlBQVosQ0FBWCxDQUFQLENBQWIsRUFBNEQsRUFBQ0MsTUFBTXJCLFVBQVAsRUFBNUQ7QUFDQSxDQUZEIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgTW9uZ29DbGllbnQgPSByZXF1aXJlKCdtb25nb2RiJykuTW9uZ29DbGllbnRcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnXG5pbXBvcnQgY29tcHJlc3Npb24gZnJvbSAnY29tcHJlc3Npb24nXG5pbXBvcnQgYm9keVBhcnNlciBmcm9tICdib2R5LXBhcnNlcidcbmltcG9ydCBjb3JzIGZyb20gJ2NvcnMnXG5cbmltcG9ydCB7IGNoYXB0ZXJUZXh0IH0gZnJvbSBcIi4vYXBpL2NoYXB0ZXItdGV4dFwiXG5pbXBvcnQgeyB3b3JkTG9va3VwIH0gZnJvbSBcIi4vYXBpL3dvcmQtbG9va3VwXCJcbmltcG9ydCB7IHRlcm1TZWFyY2gsIGNvbGxvY2F0aW9uU2VhcmNoIH0gZnJvbSBcIi4vYXBpL3Rlcm0tc2VhcmNoXCJcblxuaW1wb3J0IExvZyBmcm9tIFwiLi91dGlsL2xvZ2dpbmdcIlxuXG5sZXQgdGhpbmdzID0ge1xuXHRtb25nbzogZmFsc2UsXG5cdGV4cHJlc3M6IGZhbHNlXG59XG5jb25zb2xlLmxvZyhcIldBSVRJTkc6XCIsIE9iamVjdC5rZXlzKHRoaW5ncykuZmlsdGVyKGsgPT4gdGhpbmdzW2tdKSlcbmNvbnN0IGRlY2xhcmVfcmVhZHkgPSAodGhpbmcpID0+IHtcblx0Y29uc29sZS5sb2coXCJSRUFEWTpcIiwgdGhpbmcpXG5cdHRoaW5nc1t0aGluZ10gPSB0cnVlXG5cdGlmIChPYmplY3Qua2V5cyh0aGluZ3MpLnJlZHVjZSgoYywgaykgPT4gYyAmJiB0aGluZ3Nba10sIHRydWUpKSB7XG5cdFx0Y29uc29sZS5sb2coXCJSRUFEWSBSRUFEWSBSRUFEWSFcIilcblx0fVxufVxuXG5jb25zdCBtb25nb0Nvbm5lY3Rpb25TdHJpbmcgPSBwcm9jZXNzLmVudi5NT05HT19DT05ORUNUSU9OX1NUUklOR1xuY29uc3QgbW9uZ29EYXRhYmFzZSA9IHByb2Nlc3MuZW52Lk1PTkdPX0RBVEFCQVNFXG5jb25zdCBtb25nb1VybCA9IGBtb25nb2RiOi8vJHttb25nb0Nvbm5lY3Rpb25TdHJpbmd9LyR7bW9uZ29EYXRhYmFzZX1gXG5cbmxldCBtb25nb0Nvbm5lY3Rpb24gPSBudWxsO1xuTW9uZ29DbGllbnQuY29ubmVjdChtb25nb1VybCwgKGVyciwgZGIpID0+IHtcblx0aWYgKGVycikge1xuXHRcdGNvbnNvbGUubG9nKFwiRXJyb3Igc2V0dGluZyB1cCBtb25nbyBjb25uZWN0aW9uXCIpXG5cdFx0Y29uc29sZS5sb2coZXJyKVxuXHR9XG5cdGVsc2Uge1xuXHRcdG1vbmdvQ29ubmVjdGlvbiA9IGRiXG5cdFx0ZGVjbGFyZV9yZWFkeShcIm1vbmdvXCIpXG5cdH1cbn0pXG5cbmxldCBhcHAgPSBleHByZXNzKClcbmFwcC51c2UoY29tcHJlc3Npb24oKSlcbmFwcC51c2UoYm9keVBhcnNlci5qc29uKCkpXG5hcHAudXNlKGNvcnMoKSlcbmxldCBwb3J0ID0gK3Byb2Nlc3MuZW52LlBPUlQgfHwgMzAwMFxubGV0IGhvc3QgPSBwcm9jZXNzLmVudi5IT1NUIHx8IFwiMTI3LjAuMC4xXCJcbmxldCBzZXJ2ZXIgPSBhcHAubGlzdGVuKHBvcnQsIGhvc3QsICgpID0+IHtcblx0Y29uc29sZS5sb2coXCJTZXJ2ZXIgbGlzdGVuaW5nIHRvICVzOiVkIHdpdGhpbiAlcyBlbnZpcm9ubWVudFwiLCBob3N0LCBwb3J0LCBhcHAuZ2V0KCdlbnYnKSlcblx0ZGVjbGFyZV9yZWFkeShcImV4cHJlc3NcIilcbn0pXG5cbi8vIFVzZSBYLUZvcndhcmRlZC1Gb3JcbmFwcC5zZXQoJ3RydXN0IHByb3h5JywgJ2xvb3BiYWNrJylcblxuXG5jb25zb2xlLmxvZyhcIlNldHRpbmcgdXAgcm91dGVzXCIpXG5hcHAucG9zdChbJy9hcGknLCAnL2FwaS8qJ10sIChyZXEsIHJlcykgPT4ge1xuXHRjb25zdCBhcGlfcmVxdWVzdCA9IHJlcS5wYXJhbXNcblx0Y29uc3QgcGFyYW1zID0gcmVxLmJvZHlcblx0Y29uc29sZS5sb2coYXBpX3JlcXVlc3RbMF0pXG5cdExvZyh7IGFwaV9yZXF1ZXN0LCBwYXJhbXMsIGlwX2FkZHJlc3M6IHJlcS5pcCB9KVxuXG5cdGxldCByZXNwb25zZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiByZXNvbHZlKCkpXG5cdHN3aXRjaChhcGlfcmVxdWVzdFswXSkge1xuXHRcdGNhc2UgXCJ0ZXJtLXNlYXJjaFwiOlxuXHRcdFx0cmVzcG9uc2VQcm9taXNlID0gdGVybVNlYXJjaChwYXJhbXMsIG1vbmdvQ29ubmVjdGlvbilcblx0XHRcdGJyZWFrXG5cdFx0Y2FzZSBcImNvbGxvY2F0aW9uLXNlYXJjaFwiOlxuXHRcdFx0cmVzcG9uc2VQcm9taXNlID0gY29sbG9jYXRpb25TZWFyY2gocGFyYW1zKVxuXHRcdFx0Ly8gcmVzcG9uc2UgPSB0ZXJtU2VhcmNoKHBhcmFtcykgXG5cdFx0XHRicmVha1xuXHRcdGNhc2UgXCJ3b3JkLXN0dWR5XCI6XG5cdFx0XHQvLyByZXNwb25zZSA9IHRlcm1TZWFyY2gocGFyYW1zKSBcblx0XHRcdGJyZWFrXG5cdFx0Y2FzZSBcIndvcmQtbG9va3VwXCI6XG5cdFx0XHRyZXNwb25zZVByb21pc2UgPSB3b3JkTG9va3VwKHBhcmFtcywgbW9uZ29Db25uZWN0aW9uKSBcblx0XHRcdGJyZWFrXG5cdFx0Y2FzZSBcInRlcm0taGlnaGxpZ2h0c1wiOlxuXHRcdFx0Ly8gcmVzcG9uc2UgPSB0ZXJtU2VhcmNoKHBhcmFtcykgXG5cdFx0XHRicmVha1xuXHRcdGNhc2UgXCJjaGFwdGVyLXRleHRcIjpcblx0XHRcdHJlc3BvbnNlUHJvbWlzZSA9IGNoYXB0ZXJUZXh0KHBhcmFtcywgbW9uZ29Db25uZWN0aW9uKVxuXHRcdFx0YnJlYWtcblx0XHRkZWZhdWx0OlxuXHRcdFx0cmVzcG9uc2VQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHRyZWplY3Qoe1xuXHRcdFx0XHRcdFwiZXJyb3JcIjogXCJJbnZhbGlkIGFwaSByZXF1ZXN0LiBSZXF1ZXN0IHNob3VsZCBiZSBmb3JtYXR0ZWQgL2FwaS88dHlwZSBvZiByZXF1ZXN0PlwiLFxuXHRcdFx0XHRcdFwib3B0aW9uc1wiOiBbXG5cdFx0XHRcdFx0XHRcInRlcm0tc2VhcmNoXCIsXG5cdFx0XHRcdFx0XHRcImNvbGxvY2F0aW9uLXNlYXJjaFwiLFxuXHRcdFx0XHRcdFx0XCJ3b3JkLXN0dWR5XCIsXG5cdFx0XHRcdFx0XHRcIndvcmQtbG9va3VwXCIsXG5cdFx0XHRcdFx0XHRcInRlcm0taGlnaGxpZ2h0c1wiLFxuXHRcdFx0XHRcdFx0XCJjaGFwdGVyLXRleHRcIlxuXHRcdFx0XHRcdF1cblx0XHRcdFx0fSlcblx0XHRcdH0pXG5cdFx0XHRicmVha1xuXHR9XG5cdHJlc3BvbnNlUHJvbWlzZS50aGVuKChyZXNwb25zZSkgPT4ge1xuXHRcdHJlcy5zZW5kKHJlc3BvbnNlKVxuXHR9KS5jYXRjaCgocmVzcG9uc2UpID0+IHtcblx0XHRyZXMuc2VuZChyZXNwb25zZSlcblx0XHRjb25zb2xlLmxvZyhcImVycm9yXCIpXG5cdFx0Y29uc29sZS5sb2cocmVzcG9uc2UpXG5cdH0pXG59KVxuXG5cbmNvbnN0IGNsaWVudFJvb3QgPSBwcm9jZXNzLmVudi5QQVJBQklCTEVfQ0xJRU5UX0RJUlxuY29uc3QgZ2V0VXJsID0gKG1vYmlsZSkgPT4ge1xuXHRpZiAobW9iaWxlKVxuXHRcdHJldHVybiAnL21vYmlsZS5odG1sJ1xuXHRlbHNlXG5cdFx0cmV0dXJuICcvaW5kZXguaHRtbCdcbn1cbmNvbnN0IG5lZWRzRm9udHMgPSAodXNlckFnZW50KSA9PiB7XG5cdC8vIHRlY2huaWNhbGx5IHRoaXMgaXMgbm90IG1vYmlsZSAtIGl0J3Mgd2hldGhlciBvciBub3QgdG8gZHVtcCBmb250cyBpbnRvIHRoZSBpbmRleC5odG1sXG5cdGNvbnN0IHJlZ2V4Rm9yTW9iaWxlID0ge1xuXHRcdC8vIFdpbmRvd3M6IC93aW5kb3dzIG50L2ksXG5cdFx0V2luZG93c1Bob25lOiAvd2luZG93cyBwaG9uZS9pLFxuXHRcdC8vIE1hYzogL21hY2ludG9zaC9pLFxuXHRcdC8vIExpbnV4OiAvbGludXgvaSxcblx0XHRXaWk6IC93aWkvaSxcblx0XHRQbGF5c3RhdGlvbjogL3BsYXlzdGF0aW9uL2ksXG5cdFx0aVBhZDogL2lwYWQvaSxcblx0XHRpUG9kOiAvaXBvZC9pLFxuXHRcdGlQaG9uZTogL2lwaG9uZS9pLFxuXHRcdEFuZHJvaWQ6IC9hbmRyb2lkL2ksXG5cdFx0QmxhY2tiZXJyeTogL2JsYWNrYmVycnkvaSxcblx0XHRTYW1zdW5nOiAvc2Ftc3VuZy9pLFxuXHRcdC8vIEN1cmw6IC9jdXJsL2lcblx0XHRNb2JpbGU6IC9tb2JpbGUvaVxuXHR9XG5cdHJldHVybiBPYmplY3Qua2V5cyhyZWdleEZvck1vYmlsZSkucmVkdWNlKChhLCBrKSA9PlxuXHRcdGEgfHwgcmVnZXhGb3JNb2JpbGVba10udGVzdCh1c2VyQWdlbnQpLFxuXHRmYWxzZSlcbn1cblxuLy8gUm91dGUgb3JkZXIgbWF0dGVycyAtIHRoZSBmaXJzdCBsaXN0ZWQgd2lsbCBiZSBpbnZva2VkXG5hcHAuZ2V0KFwiL1wiLCAocmVxLCByZXMpID0+IHtcblx0cmVzLnNlbmRGaWxlKGdldFVybChuZWVkc0ZvbnRzKHJlcS5oZWFkZXJzW1widXNlci1hZ2VudFwiXSkpLCB7cm9vdDogY2xpZW50Um9vdH0pXG59KVxuYXBwLnVzZShleHByZXNzLnN0YXRpYyhjbGllbnRSb290KSlcbmFwcC5nZXQoXCIqXCIsIChyZXEsIHJlcykgPT4ge1xuXHRyZXMuc2VuZEZpbGUoZ2V0VXJsKG5lZWRzRm9udHMocmVxLmhlYWRlcnNbXCJ1c2VyLWFnZW50XCJdKSksIHtyb290OiBjbGllbnRSb290fSlcbn0pIl19